<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<title>Neptune — Central JSON (hard load)</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
  .nc-wrap{position:fixed;right:12px;bottom:12px;z-index:99999}
  .nc-bar{display:flex;gap:8px;align-items:center;background:#fff;border:1px solid #e5e7eb;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,.08);padding:8px 10px}
  .nc-btn{padding:6px 10px;border-radius:8px;border:1px solid #ddd;background:#f7f7f7;cursor:pointer;font:13px system-ui}
  .nc-btn.primary{background:#1a7f37;border-color:#1a7f37;color:#fff}
  .nc-status{color:#333;margin-left:6px;font:13px system-ui}
</style>
</head>
<body>
<div class="nc-wrap">
  <div class="nc-bar">
    <button class="nc-btn" id="nc-load">← Charger (central)</button>
    <button class="nc-btn primary" id="nc-save">Enregistrer → (central)</button>
    <span id="nc-status" class="nc-status">—</span>
  </div>
</div>

<script>
(function(){"use strict";
  const API_KEY  = '1c5f1698-c8f7-4992-988a-d1ae29cb35ee';
  const LONG_URI = 'https://api.jsonstorage.net/v1/json/88ff1334-435e-4e42-bcf4-65ee4777fa1f/caa3fc75-d869-4cc7-99fa-7fa93b38145c';

  const $ = (s)=>document.querySelector(s);
  const at = ()=> new Date().toLocaleTimeString();
  const S = (m, ok)=>{ const el=$("#nc-status"); if(el){ el.textContent=m+" ("+at()+")"; el.style.color = ok ? "#0a7d00":"#333"; } };
  const withKey = (u)=> u + (u.includes("?")?"&":"?") + "apiKey=" + encodeURIComponent(API_KEY);

  function ensureData(){
    try{ if(typeof window.save==="function") window.save(); }catch(_ ){}
    if(!window.data || typeof window.data!=="object") window.data = {};
    if(!window.data.__meta) window.data.__meta={};
    window.data.__meta.updatedAt = new Date().toISOString();
    return window.data;
  }

  function safeClone(value,maxDepth=12){
    const seen = new WeakSet();
    function c(v,d){
      if(d<0) return null;
      if(v===null || typeof v!=="object"){
        if(typeof v==="function") return null;
        if(typeof v==="bigint") return String(v);
        return v;
      }
      if(v instanceof Date) return new Date(v).toISOString();
      if(v instanceof RegExp) return v.toString();
      if(typeof Element!=="undefined" && v instanceof Element) return null;
      if(typeof Node!=="undefined" && v instanceof Node) return null;
      if(seen.has(v)) return null; seen.add(v);
      if(Array.isArray(v)) return v.map(x=>c(x,d-1));
      const o={}; for(const k in v){ if(!Object.prototype.hasOwnProperty.call(v,k)) continue; if(k==="__proto__") continue;
        try{ o[k]=c(v[k],d-1); }catch(_ ){ o[k]=null; }
      } return o;
    }
    return c(value,maxDepth);
  }

  async function centralGET(){
    const r = await fetch(withKey(LONG_URI), { method:"GET", cache:"no-cache" });
    const t = await r.text();
    if(!r.ok) throw new Error("GET "+r.status+" — "+t.slice(0,200));
    return JSON.parse(t || "{}");
  }

  async function centralPUT(obj){
    const body = JSON.stringify(obj);
    const r = await fetch(withKey(LONG_URI), {
      method:"PUT",
      headers:{"Content-Type":"application/json"},
      body,
      cache:"no-store"
    });
    const t = await r.text();
    if(!r.ok) throw new Error("PUT "+r.status+" — "+t.slice(0,200));
    return true;
  }

  const KNOWN_KEYS = ["praticiens","praticien","internes","stagiaires","salles","rooms","specialites","specialités","absences","replacements","planning","calendrier","data","neptune_data"];

  function hydrateLocalStorageFrom(remote){
    try{
      // remove known keys first
      KNOWN_KEYS.forEach(k=>localStorage.removeItem(k));
      // write all top-level keys
      for(const k of Object.keys(remote||{})){
        try{ localStorage.setItem(k, JSON.stringify(remote[k])); }catch(_ ){}
      }
      // write a full copy
      try{ localStorage.setItem("neptune_data", JSON.stringify(remote)); }catch(_ ){}
    }catch(_ ){}
  }

  function callIfExists(fnName){
    try{ const f = window[fnName]; if(typeof f==="function") f(); }catch(_ ){}
  }

  function applyState(remote){
    if(remote && typeof remote==="object"){
      window.data = remote;
      hydrateLocalStorageFrom(remote);
      const fns = ["refreshActivePage","render","renderAll","renderPracs","renderPracticiens","renderPractitioners","renderInterns","renderStagiaires","renderRooms","renderSalles","renderSpecs","renderSpecialites","renderAbsences","renderAbsRep","renderCalendar","renderCalendars","renderPlanning","renderStats","initUI","updateUI","fullRefresh"];
      fns.forEach(callIfExists);
      try{ if(typeof window.save==="function") window.save(); }catch(_ ){}
      try{ window.dispatchEvent(new Event("neptune:central-loaded")); }catch(_ ){}
    }
  }

  async function hardLoad(){
    try{ S("Chargement central…"); const j = await centralGET(); applyState(j); S("Chargé (central)", true); }
    catch(e){ console.warn(e); S("Échec chargement central"); }
  }

  async function doPush(){
    if(location.protocol==="file:") return S("Ouvre en https");
    try{
      S("Préparation…");
      const d = ensureData();
      const cloned = safeClone(d,12);
      const payload = JSON.stringify(cloned);
      const kb = Math.round(payload.length/1024);
      S("Écriture… ("+kb+" Ko)");
      await centralPUT(cloned);
      S("Enregistré ✅", true);
    }catch(e){ console.warn(e); S("Échec écriture"); }
  }

  document.addEventListener("DOMContentLoaded", ()=>{
    document.getElementById("nc-load")?.addEventListener("click", hardLoad);
    document.getElementById("nc-save")?.addEventListener("click", doPush);
    // Hard load on start
    hardLoad().catch(()=>{});
  });

  window.neptuneCentral = { load: ()=>hardLoad(), save: ()=>doPush() };
})();
</script>
</body>
</html>