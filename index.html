<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<title>Neptune — Sauvegarde centrale (v3 debug)</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
  :root{--bg:#f8fafc;--card:#fff;--muted:#667085;--ok:#0a7d00;--err:#b00020;--border:#e5e7eb;--accent:#1a7f37;--shadow:0 2px 10px rgba(0,0,0,.08);}
  body{margin:0;background:var(--bg);font:14px system-ui,Segoe UI,Roboto,Arial,sans-serif;color:#111}
  .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
  h1{font-size:20px;margin:0 0 16px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:14px;box-shadow:var(--shadow);padding:16px;margin-bottom:16px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:8px 0}
  button{padding:8px 12px;font-size:14px;border-radius:10px;border:1px solid var(--border);background:#f7f7f7;cursor:pointer}
  button.primary{background:var(--accent);border-color:var(--accent);color:#fff}
  code.kv{background:#f6f6f6;border-radius:6px;padding:2px 6px}
  textarea{width:100%;height:280px;border:1px solid var(--border);border-radius:10px;padding:10px;font-family:ui-monospace,Consolas,monospace;font-size:13px;line-height:1.4}
  .muted{color:var(--muted)} .ok{color:var(--ok)} .err{color:var(--err)}
  .log{white-space:pre-wrap;word-break:break-word}
  .bar{position:fixed;right:12px;bottom:12px;display:flex;gap:8px;align-items:center;background:#fff;border:1px solid var(--border);border-radius:10px;box-shadow:var(--shadow);padding:8px 10px;z-index:9999}
</style>
</head>
<body>
<div class="wrap">
  <h1>Neptune — Sauvegarde centrale (JsonStorage / URI longue) — v3</h1>

  <div class="card">
    <div class="row"><b>Point d'écriture</b> : <code class="kv">https://api.jsonstorage.net/v1/json/88ff1334-435e-4e42-bcf4-65ee4777fa1f/caa3fc75-d869-4cc7-99fa-7fa93b38145c</code></div>
    <div class="row">
      <button id="btnTest">Tester GET</button>
      <button id="btnPush" class="primary">Enregistrer →</button>
      <button id="btnPull">← Charger</button>
      <button id="btnPushTiny">Test écriture minimale</button>
    </div>
    <div id="status" class="muted log">—</div>
    <div id="err" class="err log" style="display:none"></div>
  </div>

  <div class="card">
    <b>Éditeur JSON (lié à window.data)</b>
    <div class="row">
      <button id="btnFromData">↺ Depuis window.data</button>
      <button id="btnToData" class="primary">⮕ Vers window.data</button>
      <span id="editStatus" class="muted">—</span>
    </div>
    <textarea id="editor" spellcheck="false" placeholder='{"exemple":true}'></textarea>
  </div>
</div>

<div class="bar">
  <button id="barLoad">← Charger</button>
  <button id="barSave" class="primary">Enregistrer →</button>
  <span id="barStatus" class="muted">—</span>
</div>

<script>
(function(){"use strict";
  const API_KEY="1c5f1698-c8f7-4992-988a-d1ae29cb35ee";
  const LONG_URI="https://api.jsonstorage.net/v1/json/88ff1334-435e-4e42-bcf4-65ee4777fa1f/caa3fc75-d869-4cc7-99fa-7fa93b38145c";

  const $=(s)=>document.querySelector(s);
  const at = ()=> new Date().toLocaleTimeString();
  const withKey = (u)=> u + (u.includes("?")?"&":"?") + "apiKey=" + encodeURIComponent(API_KEY);
  const S=(m,cls="muted")=>{ const el=$("#status"); el.textContent=m+" ("+at()+")"; el.className="log "+cls; console.log("[status]",m); };
  const BS=(m)=>{ $("#barStatus").textContent=m+" ("+at()+")"; };
  const showErr=(m)=>{ const el=$("#err"); el.style.display="block"; el.textContent=m; console.error(m); };
  const hideErr=()=>{ const el=$("#err"); el.style.display="none"; el.textContent=""; };

  // Safe stringify: évite les cycles, DOM, fonctions, BigInt
  function safeClone(value,maxDepth=10) {
    const seen = new WeakSet();
    function clone(v, depth) {
      if (depth<0) return null;
      if (v === null || typeof v !== "object") {
        if (typeof v === "function") return null;
        if (typeof v === "bigint") return String(v);
        return v;
      }
      if (v instanceof Date) return new Date(v).toISOString();
      if (v instanceof RegExp) return v.toString();
      if (typeof Element !== "undefined" && v instanceof Element) return null;
      if (typeof Node !== "undefined" && v instanceof Node) return null;

      if (seen.has(v)) return null;
      seen.add(v);

      if (Array.isArray(v)) return v.map((x)=>clone(x, depth-1));

      const out={};
      for (const k in v) {
        if (!Object.prototype.hasOwnProperty.call(v,k)) continue;
        if (k === "__proto__") continue;
        try { out[k] = clone(v[k], depth-1); }
        catch(e) { out[k] = null; }
      }
      return out;
    }
    return clone(value,maxDepth);
  }

  function ensureData() {
    try { if (typeof window.save === "function") window.save(); } catch (_) { }
    if (!window.data || typeof window.data !== "object") window.data = {};
    if (!window.data.__meta) window.data.__meta = {};
    window.data.__meta.updatedAt = new Date().toISOString();
    // tente aussi 'data' global si présent
    try { if (typeof window.data === "object") window.data = Object.assign({}, window.data); } catch(_) {}
    if (typeof window.data === "object" && window.data !== null) return window.data;
    return {};
  }

  async function centralGET() {
    const r = await fetch(withKey(LONG_URI), { method:"GET", cache:"no-cache" });
    const t = await r.text();
    if (!r.ok) throw new Error("GET "+r.status+" — "+t.slice(0,300));
    return JSON.parse(t || "{}");
  }

  async function centralPUT(obj) {
    const body = JSON.stringify(obj);
    const r = await fetch(withKey(LONG_URI), { method:"PUT", headers:{"Content-Type":"application/json"}, body, cache:"no-store" });
    const t = await r.text();
    if (!r.ok) throw new Error("PUT "+r.status+" — "+t.slice(0,300));
    return { status:r.status, body:t };
  }

  async function doTest() {
    hideErr();
    try { const r = await fetch(withKey(LONG_URI), { method:"GET", cache:"no-cache" }); const t = await r.text(); S("Test "+r.status+(r.ok?" OK":" — "+t.slice(0,120)), r.ok?"ok":"err"); }
    catch(e) { S("Test — "+(e.message||e),"err"); }
  }

  function applyState(remote) {
    if (remote && typeof remote === "object") {
      // affecte à window.data ET data si présent
      window.data = remote;
      try { if ("data" in window) window.data = window.data; } catch(_) {}
      try { if (typeof window.refreshActivePage === "function") window.refreshActivePage(); } catch (_) {}
      try { if (typeof window.render === "function") window.render(); } catch (_) {}
      try { $("#editor").value = JSON.stringify(window.data, null, 2); } catch(_) {}
    }
  }

  async function doPull() {
    hideErr();
    try { S("Lecture…"); BS("Lecture…"); const j = await centralGET(); applyState(j); S("Chargé","ok"); BS("Chargé"); }
    catch(e) { S("Échec lecture — "+(e.message||e),"err"); BS("Échec lecture"); showErr(String(e.message||e)); }
  }

  async function doPush() {
    hideErr();
    if (location.protocol === "file:") { S("Ouvre en HTTPS (GitHub Pages)","err"); BS("Ouvre en HTTPS"); return; }
    try {
      S("Préparation…"); BS("Préparation…");
      const raw = ensureData();
      const cloned = safeClone(raw, 12);
      const bodyStr = JSON.stringify(cloned);
      const kb = Math.round(bodyStr.length / 1024);
      S("Écriture… (payload ~"+kb+" Ko)"); BS("Écriture…");
      const res = await centralPUT(cloned);
      S("Enregistré ✅ — HTTP "+res.status+" — payload "+kb+" Ko","ok"); BS("Enregistré ✅");
    } catch(e) {
      S("Échec écriture — "+(e.message||e),"err"); BS("Échec écriture"); showErr(String(e.message||e));
    }
  }

  async function doPushTiny() {
    hideErr();
    try {
      const tiny = {_health:"ok", t: Date.now()};
      const res = await centralPUT(tiny);
      S("Test écriture: HTTP "+res.status+" — OK","ok");
    } catch(e) { S("Test écriture — "+(e.message||e),"err"); showErr(String(e.message||e)); }
  }

  // Éditeur
  $("#btnFromData").onclick = ()=>{ try{ $("#editor").value = JSON.stringify(ensureData(), null, 2); $("#editStatus").textContent="→ Éditeur mis à jour ("+at()+")"; }catch(e){ $("#editStatus").textContent="Erreur: "+e; } };
  $("#btnToData").onclick   = ()=>{ try{ const j = JSON.parse($("#editor").value||"{}"); window.data = j; $("#editStatus").textContent="→ window.data mis à jour ("+at()+")"; }catch(e){ $("#editStatus").textContent="JSON invalide: "+e; } };

  // Bind
  $("#btnTest").onclick = doTest;
  $("#btnPush").onclick = doPush;
  $("#btnPull").onclick = doPull;
  $("#btnPushTiny").onclick = doPushTiny;
  $("#barSave").onclick = doPush;
  $("#barLoad").onclick = doPull;
  
  // Auto: charge à l'ouverture
  document.addEventListener("DOMContentLoaded", ()=>{ doPull().catch(()=>{}); });

})();
</script>
</body>
</html>
