<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Neptune — par CHEDDAD EL AOUNI Mourad</title>
<style>
:root{
  --bg:#0d1b3d;           /* bleu foncé */
  --bg2:#1e3f8a;          /* bleu moyen */
  --panel:#102a5c;        /* panneau */
  --panel2:#163a7e;       /* panneau plus clair */
  --line:#2a4ea8;
  --text:#eef6ff;
  --muted:#bcd1ff;
  --acc:#5aa0ff;
  --ok:#1e6e5a;
  --err:#8b3a3a;
  --warn:#8b7a3a;
  --rad:14px;
}
*{box-sizing:border-box}
body{
  margin:0;
  background:linear-gradient(180deg, var(--bg) 0%, var(--bg2) 60%);
  color:var(--text);
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial
}
header{position:sticky;top:0;background:rgba(13,27,61,.9);backdrop-filter:blur(6px);border-bottom:1px solid var(--line);z-index:10}
.head{display:flex;gap:10px;align-items:center;justify-content:space-between;padding:10px 14px}
h1{margin:0;font-size:16px}
.badges{display:flex;gap:8px;align-items:center}
.badge{background:#103074;border:1px solid #2a4fa7;color:#d9e4ff;padding:3px 7px;border-radius:999px;font-size:12px}
nav{display:flex;gap:8px;overflow:auto;padding:8px 14px;border-top:1px solid #0f1b3e;border-bottom:1px solid var(--line);background:rgba(13,27,61,.9)}
nav button{white-space:nowrap;border:1px solid #28407f;color:#e7f0ff;padding:6px 10px;border-radius:999px;font-size:13px;cursor:pointer;background:#0f2558}
nav button.active{background:#1a49ad;color:#fff;border-color:#3a60c7}
.container{max-width:1280px;margin:0 auto;padding:14px}
.card{background:linear-gradient(180deg, var(--panel) 0%, var(--panel2) 100%);border:1px solid var(--line);border-radius:var(--rad);margin:12px 0;overflow:hidden}
.card-h{padding:10px 12px;border-bottom:1px solid var(--line);display:flex;gap:8px;align-items:center;justify-content:space-between}
.card-b{padding:10px 12px}
.grid{display:grid;gap:8px}
.g2{grid-template-columns:repeat(2,1fr)}
.g3{grid-template-columns:repeat(3,1fr)}
.g4{grid-template-columns:repeat(4,1fr)}
@media(max-width:860px){.g2,.g3,.g4{grid-template-columns:1fr}}
label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
input,select,button{font-size:14px}
input[type=text],input[type=number],select{width:100%;padding:9px 10px;border-radius:10px;border:1px solid #22408f;background:#0e2458;color:#eef6ff}
button{border-radius:10px;border:1px solid #2b4fb0;background:#13367a;color:#e7edff;padding:8px 11px;cursor:pointer}
button.ghost{background:transparent;border-style:dashed;color:#cfe0ff}
button.small{font-size:12px;padding:6px 8px}
.table{overflow:auto;border:1px solid var(--line);border-radius:10px}
table{width:100%;border-collapse:separate;border-spacing:0;font-size:13px}
th,td{padding:8px 10px;border-bottom:1px solid var(--line);vertical-align:top}
th{position:sticky;top:0;background:#102d69;text-align:left}
td:first-child,th:first-child{position:sticky;left:0;background:#0e2a62;border-right:1px solid var(--line)}
.segment{margin:4px 0;padding:6px 8px;border:1px solid #2a56b7;border-radius:8px;background:#0f2b6b;position:relative}
.segment .dot{position:absolute;left:6px;top:50%;transform:translateY(-50%);width:10px;height:10px;border-radius:50%;border:1px solid rgba(255,255,255,.6)}
.segment .body{padding-left:18px;display:block}
.small{font-size:12px;color:#cfe0ff}
.muted{color:#b9ccff}
.hidden{display:none}
.sep{height:10px}
.tag{font-size:11px;border:1px solid #2a4fa7;background:#0f2c6e;color:#d9e4ff;border-radius:6px;padding:2px 6px;margin-left:6px}
.tag.err{border-color:#8b3a3a;background:#2b1111;color:#ffd0d0}
.tag.warn{border-color:#8b7a3a;background:#2b2411;color:#ffe7b5}
.subtabs{display:flex;gap:8px;padding:8px 12px;border-bottom:1px dashed var(--line);background:#0e2a62}
.subtabs button{border:1px solid #28407f;color:#cfe0ff;padding:6px 10px;border-radius:999px;font-size:12px;background:transparent;cursor:pointer}
.subtabs button.active{background:#1a49ad;color:#fff;border-color:#3a60c7}
.controls{display:flex;flex-wrap:wrap;gap:8px;align-items:flex-end}
.controls .item{min-width:180px}
.seg{display:flex;border:1px solid #2a4ea8;border-radius:999px;overflow:hidden}
.seg button{border:0;background:transparent;color:#cfe0ff;padding:6px 12px}
.seg button.active{background:#1a49ad;color:#fff}
.cal{display:grid;grid-template-columns:repeat(7,1fr);border:1px solid var(--line);border-radius:10px;overflow:hidden}
.cal .hd{background:#0e2a62;border-bottom:1px solid var(--line);padding:6px 8px;font-weight:600}
.cal .cell{min-height:120px;border-right:1px solid var(--line);border-bottom:1px solid var(--line);padding:6px 8px}
.cal .cell:nth-child(7n){border-right:0}
.cal .dt{font-size:12px;color:#cfe0ff;margin-bottom:4px}
.cal .chip{display:inline-block;font-size:11px;border-radius:999px;border:1px solid rgba(255,255,255,.25);padding:1px 6px;margin:2px 4px 0 0}
.cal .chip .sw{display:inline-block;width:8px;height:8px;border-radius:50%;margin-right:6px;border:1px solid rgba(255,255,255,.6)}
.hint{font-size:12px;color:#cfe0ff;opacity:.9}
hr.soft{border:0;border-top:1px dashed var(--line);margin:12px 0}
.rep-choice.selected{outline:2px solid var(--ok); box-shadow: inset 0 0 0 2px rgba(30,110,90,.35);} 
.rep-choice{transition:box-shadow .15s, outline .15s}
.csv-export{display:none !important}
#authOverlay{position:fixed;inset:0;background:rgba(13,27,61,.96);backdrop-filter:blur(6px);display:flex;align-items:center;justify-content:center;z-index:99999}
#authCard{background:linear-gradient(180deg, var(--panel) 0%, var(--panel2) 100%);border:1px solid var(--line);border-radius:var(--rad);padding:20px;min-width:320px;box-shadow:0 10px 30px rgba(0,0,0,.4)}
#authCard h2{margin:0 0 10px 0;font-size:18px}
#authCard .row{margin:8px 0}
#authErr{color:#ffd0d0;font-size:12px;min-height:16px}
</style>
</head>
<body>

<!-- Auth (facultatif) -->
<div id="authOverlay" style="display: none;">
  <form id="authCard">
    <h2>Authentification</h2>
    <div class="row">
      <label>Identifiant</label>
      <input id="authId" type="text" autocomplete="username" placeholder="Identifiant">
    </div>
    <div class="row">
      <label>Code</label>
      <input id="authCode" type="password" autocomplete="current-password" placeholder="Code">
    </div>
    <div id="authErr" class="row">Identifiants incorrects.</div>
    <div class="row">
      <button id="authBtn" type="submit">Entrer</button>
    </div>
  </form>
</div>

<header>
  <div class="head">
    <h1>Neptune — par CHEDDAD EL AOUNI Mourad</h1>
    <div class="badges">
      <span class="badge" id="wkBadge" title="Cliquer pour modifier la semaine/année globale" style="cursor: pointer;">S36 · 2025</span>
      <span class="badge" id="roleBadge">Rôle: Administrateur</span>
    </div>
  </div>
  <nav id="tabs">
    <button class="active">Sauvegarde</button>
    <button>Accueil</button>
    <button>Planning praticien</button>
    <button>Planning interne</button>
    <button>Calendrier</button>
    <button>Absences &amp; Remplacements</button>
    <button>Semaine type</button>
    <button>Absences</button>
    <button>Gardes</button>
    <button>Astreinte</button>
    <button>Données</button>
    <button>Stats</button>
  </nav>
</header>

<div class="container">

  <!-- Sauvegarde -->
  <section id="page-save" class="">
    <div class="card">
      <div class="card-h"><div>Sauvegarde</div></div>
      <div class="card-b">

        <!-- Contrôles JsonStorage -->
        <div class="controls" style="margin-bottom:8px">
          <button id="btnSimplePull">← Recharger (JsonStorage)</button>
          <button id="btnSimplePush">Pousser → (JsonStorage)</button>
          <small id="simpleSaveStatus" class="muted">Prêt</small>
        </div>
        <hr class="soft">

        <!-- Export/Import/Reset  -->
        <button id="btnExport" class="ghost">Exporter JSON</button>
        <input id="fileImport" type="file" accept="application/json">
        <button id="btnImport">Importer JSON</button>
        <button id="btnReset" class="ghost" style="margin-left:10px">Réinitialiser</button>

        <hr class="soft">

        <!-- Sauvegarde locale dans le fichier -->
        <div class="small">Enregistrer <b>directement dans ce fichier HTML</b> (nécessite Chrome/Edge récents).</div>
        <div class="controls">
          <button id="btnPickHtml">Choisir ce fichier pour l'autosauvegarde</button>
          <button id="btnSaveHtmlNow" class="ghost">Enregistrer maintenant</button>
          <small id="saveHint" class="muted"></small>
        </div>

      </div>
    </div>
  </section>

  <!-- Les autres pages sont laissées en exemple statique.
       Elles n’ont pas d’impact sur la sauvegarde JsonStorage / locale. -->

  <section id="page-acc" class="hidden">
    <div class="card"><div class="card-h"><div>Accueil — vue par salle</div></div>
      <div class="card-b">
        <div class="hint">Contenu démo.</div>
      </div>
    </div>
  </section>

  <section id="page-prac" class="hidden">
    <div class="card"><div class="card-h"><div>Planning par praticien</div></div>
      <div class="card-b"><div class="hint">Contenu démo.</div></div>
    </div>
  </section>

  <section id="page-intern" class="hidden">
    <div class="card"><div class="card-h"><div>Planning par interne</div></div>
      <div class="card-b"><div class="hint">Contenu démo.</div></div>
    </div>
  </section>

  <section id="page-cal" class="hidden">
    <div class="card"><div class="card-h"><div>Calendrier</div></div>
      <div class="card-b"><div class="hint">Contenu démo.</div></div>
    </div>
  </section>

  <section id="page-absrep" class="hidden">
    <div class="card"><div class="card-h"><div>Absences &amp; Remplacements</div></div>
      <div class="card-b"><div class="hint">Contenu démo.</div></div>
    </div>
  </section>

  <section id="page-week" class="hidden">
    <div class="card"><div class="card-h"><div>Semaine type</div></div>
      <div class="card-b"><div class="hint">Contenu démo.</div></div>
    </div>
  </section>

  <section id="page-abs" class="hidden">
    <div class="card"><div class="card-h"><div>Absences</div></div>
      <div class="card-b"><div class="hint">Contenu démo.</div></div>
    </div>
  </section>

  <section id="page-guard" class="hidden">
    <div class="card"><div class="card-h"><div>Gardes</div></div>
      <div class="card-b"><div class="hint">Contenu démo.</div></div>
    </div>
  </section>

  <section id="page-oncall" class="hidden">
    <div class="card"><div class="card-h"><div>Astreinte</div></div>
      <div class="card-b"><div class="hint">Contenu démo.</div></div>
    </div>
  </section>

  <section id="page-data" class="hidden">
    <div class="card"><div class="card-h"><div>Données</div></div>
      <div class="card-b"><div class="hint">Contenu démo.</div></div>
    </div>
  </section>

  <section id="page-stats" class="hidden">
    <div class="card"><div class="card-h"><div>Stats</div></div>
      <div class="card-b"><div class="hint">Contenu démo.</div></div>
    </div>
  </section>

</div> <!-- /.container -->

<!-- Conteneur d'état embarqué (utilisé pour sauvegarder dans le HTML) -->
<script id="NEPTUNE_EMBED" type="application/json"></script>

<script>
(function(){
  // --- Helpers DOM ---
  function $(id){ return document.getElementById(id); }
  function pad2(n){ n=parseInt(n,10); return (n<10?'0':'')+n; }

  // --- Constantes planning ---
  var KEY='neptune-v5';
  var DAYS=['Lundi','Mardi','Mercredi','Jeudi','Vendredi'];
  var GUARD_DAYS=['Lundi','Mardi','Mercredi','Jeudi','Vendredi','Samedi','Dimanche'];
  var SLOTS=(function(){ var a=[]; for(var h=8; h<20; h++) a.push((h<10?'0':'')+h+':00'); return a; })(); // 08:00..19:00
  function emptySchedule(){ var d=[]; for(var i=0;i<5;i++){ var slots=[]; for(var s=0;s<SLOTS.length;s++) slots.push({spec:'',prac:'',intern:''}); d.push(slots);} return d; }

  // =======================
  //  JsonStorage (config)
  // =======================
  const FIXED_URI = "https://api.jsonstorage.net/v1/json/88ff1334-435e-4e42-bcf4-65ee4777fa1f/1979d83c-f4b7-4e34-a4d8-bda3f1be9fd9";
  const API_KEY   = "1c5f1698-c8f7-4992-988a-d1ae29cb35ee";

  // =======================
  //  État initial
  // =======================
  var data = (function(){
    try{
      var emb = loadFromEmbed(); if(emb) return emb;
      var s = localStorage.getItem(KEY); if(s) return JSON.parse(s);
    }catch(e){}
    return {
      specialties:['NRD','NRI','Ostéo','Dig','Onco','Landerneau','Médecine légale','CINAPS'],
      practitioners:[
        {name:'MCEA',specs:['NRD','NRI'],cinaps:false},
        {name:'DBS',specs:['Dig'],cinaps:false}
      ],
      interns:[{name:'Dupont I.',specs:['NRD']}],
      rooms:[
        {name:'IRM 11',allow:['NRD','NRI'],schedule:emptySchedule()},
        {name:'IRM 12',allow:['NRD','Dig'],schedule:emptySchedule()},
        {name:'IRM urg',allow:['NRD'],schedule:emptySchedule()},
        {name:'Scanner 6',allow:['Dig','Onco'],schedule:emptySchedule()}
      ],
      absences:{}, absencesIntern:{}, guards:{}, guardsIntern:{}, oncalls:{}, overrides:{},
      __meta:{updatedAt:"", by:""}
    };
  })();

  // exposer globalement si utile ailleurs
  window.data = data;

  // =======================
  //  Sauvegarde locale (HTML)
  // =======================
  var __neptuneHandle = null;
  window.__neptuneAutosave = false;

  function loadFromEmbed(){
    try{
      var el = document.getElementById('NEPTUNE_EMBED');
      if(el && el.textContent && el.textContent.trim()){
        return JSON.parse(el.textContent);
      }
    }catch(e){}
    return null;
  }

  function writeEmbed(obj){
    try{
      var el = document.getElementById('NEPTUNE_EMBED');
      if(!el){
        el = document.createElement('script');
        el.type = 'application/json';
        el.id = 'NEPTUNE_EMBED';
        document.body.appendChild(el);
      }
      el.textContent = JSON.stringify(obj);
    }catch(e){}
  }

  async function saveHtmlToDisk(){
    try{
      writeEmbed(data);
      let handle = __neptuneHandle;
      if(!handle){
        if(!window.showSaveFilePicker){
          alert("Votre navigateur ne permet pas l'écriture directe. Utilisez Exporter JSON.");
          return;
        }
        handle = await window.showSaveFilePicker({
          suggestedName: (document.title || 'neptune') + '.html',
          types: [{ description: 'HTML', accept: { 'text/html': ['.html', '.htm'] } }]
        });
        __neptuneHandle = handle;
        window.__neptuneAutosave = true;
      }
      const writable = await handle.createWritable();
      const htmlText = '<!doctype html>\n' + document.documentElement.outerHTML; // <-- vrai \n
      await writable.write(htmlText);
      await writable.close();
      var hint = $('saveHint'); if(hint) hint.textContent = 'Enregistré dans le fichier.';
    }catch(err){
      console.error(err);
      alert('Échec de la sauvegarde dans le fichier: ' + (err && err.message ? err.message : err));
    }
  }

  async function pickHtmlFile(){
    try{
      if(!window.showOpenFilePicker){
        alert("Votre navigateur ne permet pas la sélection d'un fichier pour écriture.");
        return;
      }
      const [handle] = await window.showOpenFilePicker({
        types: [{ description: 'HTML', accept: { 'text/html': ['.html', '.htm'] } }]
      });
      __neptuneHandle = handle;
      window.__neptuneAutosave = true;
      var hint = $('saveHint'); if(hint) hint.textContent = "Autosauvegarde activée sur ce fichier.";
      await saveHtmlToDisk();
    }catch(err){
      if(err && err.name === 'AbortError') return;
      console.error(err);
      alert("Impossible d'activer l'autosauvegarde: " + (err && err.message ? err.message : err));
    }
  }

  function enhanceSavePageUI(){
    try{
      var pickBtn = $('btnPickHtml');
      var saveNowBtn = $('btnSaveHtmlNow');
      if(pickBtn){ pickBtn.onclick = pickHtmlFile; }
      if(saveNowBtn){ saveNowBtn.onclick = saveHtmlToDisk; }
      var hint = $('saveHint');
      if(hint){
        if(!('showOpenFilePicker' in window)){
          hint.textContent = "Astuce: Chrome/Edge récents requis pour l'écriture directe. Sinon, Exporter/Importer JSON.";
        }else{
          hint.textContent = window.__neptuneAutosave ? "Autosauvegarde active." : "Sélectionnez un fichier HTML pour activer l'autosauvegarde.";
        }
      }
    }catch(e){}
  }

  // =======================
  //  JsonStorage (GET/PUT)
  // =======================
  function status(msg){
    var el = $('simpleSaveStatus');
    if(el) el.textContent = msg + " (" + new Date().toLocaleTimeString() + ")";
  }
  function deviceId(){
    try{
      let id=localStorage.getItem('neptune-device');
      if(!id){ id=Math.random().toString(36).slice(2)+'-'+Date.now().toString(36); localStorage.setItem('neptune-device',id); }
      return id;
    }catch(e){ return 'device'; }
  }
  function stamp(){
    try{
      if(!data.__meta) data.__meta={};
      data.__meta.updatedAt=new Date().toISOString();
      data.__meta.by=deviceId();
    }catch(e){}
  }

  async function jsGet(){
    const u = FIXED_URI + (FIXED_URI.includes('?')?'&':'?') + 'apiKey=' + encodeURIComponent(API_KEY);
    const r = await fetch(u, {method:'GET', cache:'no-cache'});
    if(!r.ok) throw new Error('GET '+r.status);
    return r.json();
  }
  async function jsPut(obj){
    const u = FIXED_URI + (FIXED_URI.includes('?')?'&':'?') + 'apiKey=' + encodeURIComponent(API_KEY);
    const r = await fetch(u, {method:'PUT', headers:{'Content-Type':'application/json'}, body:JSON.stringify(obj,null,2)});
    if(!r.ok) throw new Error('PUT '+r.status);
    return r.json();
  }

  async function remotePull(){
    try{
      const remote = await jsGet();
      const ru = remote && remote.__meta && Date.parse(remote.__meta.updatedAt||'') || 0;
      const lu = data   && data.__meta   && Date.parse(data.__meta.updatedAt||'')   || 0;
      if(ru>lu || !lu){
        data = remote;               // remplace l'état
        window.data = data;          // expose global
        save(true);                  // écrit embed/LS, pas d'autopush
        status('Mise à jour tirée');
        try{ if(window.refreshActivePage) window.refreshActivePage(); }catch(_){}
      }else{
        status('Déjà à jour');
      }
    }catch(e){
      console.warn(e);
      status('Échec lecture');
    }
  }

  async function remotePush(){
    try{
      if(typeof window.beforePush === 'function'){ try{ window.beforePush(); }catch(_){ } }
      stamp();
      await jsPut(data || {});
      status('Données poussées');
    }catch(e){
      console.warn(e);
      status('Échec écriture');
    }
  }

  // Debounce autosauvegarde distante
  var __pushTimer = null;
  function __remoteSave(){
    try{ if(__pushTimer) clearTimeout(__pushTimer); }catch(_){}
    __pushTimer = setTimeout(async function(){
      try{
        stamp();
        await jsPut(data||{});
        status('Autosauvegarde distante OK');
      }catch(e){
        console.warn(e);
        status('Autosauvegarde distante: échec');
      }
    }, 700);
  }

  // =======================
  //  Export/Import/Reset
  // =======================
  function buildSaveButtons(){
    $('btnExport').onclick=function(){
      const blob = new Blob([JSON.stringify(data||{},null,2)], {type:'application/json'});
      const url  = URL.createObjectURL(blob);
      const a    = document.createElement('a');
      a.href = url; a.download = 'Neptune_backup.json';
      document.body.appendChild(a);
      a.click();
      setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 0); // évite "fichier non trouvé"
    };
    $('btnImport').onclick=async function(){
      var f=$('fileImport').files[0]; if(!f) return;
      var r=new FileReader();
      r.onload=async function(){
        try{
          var j=JSON.parse(String(r.result||'{}'));
          data=j; window.data=data;
          save();                    // embed/LS + autosauvegarde distante
          status('Import OK');
        }catch(e){ alert('Import invalide'); }
      };
      r.readAsText(f);
    };
    $('btnReset').onclick=function(){
      if(!confirm('Tout réinitialiser ?')) return;
      try{ localStorage.removeItem(KEY); }catch(e){}
      data = { specialties:[], practitioners:[], interns:[], rooms:[], absences:{}, absencesIntern:{}, guards:{}, guardsIntern:{}, oncalls:{}, overrides:{}, __meta:{} };
      window.data = data;
      save();
      status('Réinitialisé');
    };
  }

  // =======================
  //  save() central
  // =======================
  function save(silent){
    try{ writeEmbed(data); }catch(e){}
    try{ localStorage.setItem(KEY, JSON.stringify(data)); }catch(e){}
    try{ if(window.__neptuneAutosave){ saveHtmlToDisk(); } }catch(e){}
    if(!silent){ __remoteSave(); }   // autosauvegarde distante (debounce)
  }
  window.save = save; // exposé

  // =======================
  //  Bind / Boot
  // =======================
  function bindRemoteButtons(){
    var pull = $('btnSimplePull'), push=$('btnSimplePush');
    if(pull && !pull.__bound){ pull.__bound=true; pull.addEventListener('click', remotePull); }
    if(push && !push.__bound){ push.__bound=true; push.addEventListener('click', remotePush); }
  }

  document.addEventListener('DOMContentLoaded', function(){
    enhanceSavePageUI();
    buildSaveButtons();
    bindRemoteButtons();
    // Pull immédiat + toutes les 5 min
    remotePull().catch(()=>{});
    setInterval(function(){ remotePull().catch(()=>{}); }, 5*60*1000);
  });

  // =======================
  //  ——— Helpers planning (remplacements) ———
  //  (versions minimales pour fonctionner sans autres fichiers)
  // =======================

  function ensureWeek(w){
    var key=String(w), i, p, nm;
    if(!data.absences[key]){ var block={}; for(i=0;i<5;i++){ block[DAYS[i]]={}; for(p=0;p<data.practitioners.length;p++){ block[DAYS[i]][data.practitioners[p].name]=false; } } data.absences[key]=block; }
    else { for(i=0;i<5;i++){ for(p=0;p<data.practitioners.length;p++){ nm=data.practitioners[p].name; if(typeof data.absences[key][DAYS[i]][nm]==='undefined') data.absences[key][DAYS[i]][nm]=false; } } }
    if(!data.absencesIntern[key]){ var blockI={}; for(i=0;i<5;i++){ blockI[DAYS[i]]={}; for(p=0;p<data.interns.length;p++){ blockI[DAYS[i]][data.interns[p].name]=false; } } data.absencesIntern[key]=blockI; }
    else { for(i=0;i<5;i++){ for(p=0;p<data.interns.length;p++){ nm=data.interns[p].name; if(typeof data.absencesIntern[key][DAYS[i]][nm]==='undefined') data.absencesIntern[key][DAYS[i]][nm]=false; } } }
    if(!data.guards[key]){ var g={}; for(i=0;i<GUARD_DAYS.length;i++) g[GUARD_DAYS[i]]=''; data.guards[key]=g; }
    if(!data.guardsIntern[key]){ var gI={}; for(i=0;i<GUARD_DAYS.length;i++) gI[GUARD_DAYS[i]]=''; data.guardsIntern[key]=gI; }
    if(!data.oncalls) data.oncalls = {};
    if(!data.oncalls[key]){
      var oc = {RI:{}, NRI:{}};
      for(i=0;i<GUARD_DAYS.length;i++){ oc.RI[GUARD_DAYS[i]]=''; oc.NRI[GUARD_DAYS[i]]=''; }
      data.oncalls[key] = oc;
    }
    if(!data.overrides[key]) data.overrides[key]={};
  }

  function isRestAfterGuard(week, dayIdx, name){
    var W=String(week); if(!name) return false;
    if(dayIdx===0){ return data.guards[W] && data.guards[W]['Dimanche']===name; }
    var prevDay=DAYS[dayIdx-1];
    return data.guards[W] && data.guards[W][prevDay]===name;
  }
  function isRestAfterGuardIntern(week, dayIdx, name){
    if(!name) return false;
    if(dayIdx===0){
      var w = parseInt(week,10)||0;
      var prevW = String(w>1 ? (w-1) : 53);
      try{ return !!(data.guardsIntern[prevW] && data.guardsIntern[prevW]['Dimanche']===name); }catch(e){ return false; }
    }
    var W = String(week);
    var prevDay = DAYS[dayIdx-1];
    try{ return !!(data.guardsIntern[W] && data.guardsIntern[W][prevDay]===name); }catch(e){ return false; }
  }

  function getAssignment(week, ri, di, si){
    var W = String(week);
    var ov = data.overrides[W] && data.overrides[W][ri] && data.overrides[W][ri][di] && data.overrides[W][ri][di][si];
    var base = data.rooms[ri].schedule[di][si];
    return {
      spec: base.spec,
      prac: base.prac,
      intern: base.intern,
      repPrac: (ov && (ov.repPrac || ov.prac)) || '',
      repIntern: (ov && (ov.repIntern || ov.intern)) || ''
    };
  }
  function setOverride(week, ri, di, si, patch){
    var W=String(week);
    if(!data.overrides[W]) data.overrides[W]={};
    if(!data.overrides[W][ri]) data.overrides[W][ri]={};
    if(!data.overrides[W][ri][di]) data.overrides[W][ri][di]={};
    if(!data.overrides[W][ri][di][si]) data.overrides[W][ri][di][si]={};
    var o=data.overrides[W][ri][di][si]; for(var k in patch){ o[k]=patch[k]; } 
    save(); // déclenche persistance (embed/LS/JsonStorage)
  }

  function weeklyLoad(week){
    ensureWeek(week);
    var load={}, i; for(i=0;i<data.practitioners.length;i++) load[data.practitioners[i].name]=0;
    for(var ri=0; ri<data.rooms.length; ri++){
      for(var d=0; d<5; d++){
        for(var s=0; s<SLOTS.length; s++){
          var a=getAssignment(week,ri,d,s);
          var owner = a.repPrac || a.prac;
          if(!owner) continue;
          if(isRestAfterGuard(week,d,owner)) continue;
          if(data.absences[String(week)][DAYS[d]][owner]) continue;
          load[owner]=(load[owner]||0)+1;
        }
      }
    }
    return load;
  }
  function weeklyLoadIntern(week){
    ensureWeek(week);
    var load={}, i; for(i=0;i<data.interns.length;i++) load[data.interns[i].name]=0;
    for(var ri=0; ri<data.rooms.length; ri++){
      for(var d=0; d<5; d++){
        for(var s=0; s<SLOTS.length; s++){
          var a=getAssignment(week,ri,d,s);
          var owner = a.repIntern || a.intern;
          if(!owner) continue;
          if(isRestAfterGuardIntern(week,d,owner)) continue;
          if(data.absencesIntern[String(week)][DAYS[d]][owner]) continue;
          load[owner]=(load[owner]||0)+1;
        }
      }
    }
    return load;
  }

  // Stubs d’UI (si votre app n’en fourni pas)
  window.refreshActivePage = window.refreshActivePage || function(){};
  window.renderAccueil     = window.renderAccueil     || function(){};
  window.beforePush        = window.beforePush        || function(){};

})(); // IIFE
</script>

<!-- ====== Replacement helpers: parallel segments + UI ====== -->
<script>
// Helpers DOM minimalistes
function el(t, a, txt){
  var e=document.createElement(t); a=a||{};
  for(var k in a){ if(k==='class') e.className=a[k]; else e.setAttribute(k,a[k]); }
  if(typeof txt!=='undefined' && txt!==null) e.appendChild(document.createTextNode(txt));
  return e;
}
function clear(n){ while(n && n.firstChild) n.removeChild(n.firstChild); }
function timeLabel(idx){ return (idx < (window.SLOTS? SLOTS.length:12) ? (window.SLOTS? SLOTS[idx] : (8+idx)+':00') : '20:00'); }

// Cohérence avec data/rooms
function coalesceRanges(list){
  // list items: {ri, room, spec, slot}
  var out=[];
  list.sort(function(a,b){ return (a.ri-b.ri) || (a.slot-b.slot); });
  for(var i=0;i<list.length;i++){
    var it=list[i];
    if(!out.length || out[out.length-1].ri!==it.ri || out[out.length-1].spec!==it.spec || out[out.length-1].end!==it.slot){
      out.push({ri:it.ri, room:it.room, spec:it.spec, start:it.slot, end:it.slot+1});
    }else{
      out[out.length-1].end = it.slot+1;
    }
  }
  return out;
}

function getParallelSegmentsForPrac(week, name, dayIdx, startIdx, endIdx, excludeRoomIdx){
  if(!name) return [];
  var hits=[], data=window.data||{rooms:[]};
  for(var ri=0; ri<data.rooms.length; ri++){
    if(typeof excludeRoomIdx==='number' && ri===excludeRoomIdx) continue;
    for(var s=startIdx; s<endIdx; s++){
      var a=getAssignment(week,ri,dayIdx,s);
      var owner = a.repPrac || a.prac;
      if(a && owner===name){
        hits.push({ri:ri, room:data.rooms[ri].name, spec:a.spec||'', slot:s});
      }
    }
  }
  return coalesceRanges(hits);
}

function getParallelSegmentsForIntern(week, name, dayIdx, startIdx, endIdx, excludeRoomIdx){
  if(!name) return [];
  var hits=[], data=window.data||{rooms:[]};
  for(var ri=0; ri<data.rooms.length; ri++){
    if(typeof excludeRoomIdx==='number' && ri===excludeRoomIdx) continue;
    for(var s=startIdx; s<endIdx; s++){
      var a=getAssignment(week,ri,dayIdx,s);
      var owner = a.repIntern || a.intern;
      if(a && owner===name){
        hits.push({ri:ri, room:data.rooms[ri].name, spec:a.spec||'', slot:s});
      }
    }
  }
  return coalesceRanges(hits);
}

function summarizeParallelSegments(arr){
  if(!arr || !arr.length) return '';
  var parts=[];
  for(var i=0;i<arr.length;i++){
    var r=arr[i];
    parts.push(r.room+' '+timeLabel(r.start)+'–'+timeLabel(r.end)+' ('+(r.spec||'—')+')');
  }
  return parts.join(', ');
}

/* UI de remplacement — utilise setOverride(...); 
   setOverride appelle save(), qui met à jour l’embed + localStorage + autosauvegarde distante (debounce).
   Au rechargement (← Recharger), remotePull() remplace window.data et l’UI est rafraîchie si vous appelez refreshActivePage(). */
function buildReplacementUI(isIntern, seg, roomIdx, dayIdx, week){
  var data = window.data||{};
  var targetName = isIntern? seg.intern : seg.prac;
  if(!targetName) return null;
  var W=String(week);

  // absent ?
  var absent = false;
  try{
    if(isIntern){
      absent = (data.absencesIntern[W] && (data.absencesIntern[W][(window.DAYS||['Lundi','Mardi','Mercredi','Jeudi','Vendredi'])[dayIdx]][targetName])) || isRestAfterGuardIntern(week,dayIdx,targetName);
    }else{
      absent = (data.absences[W] && (data.absences[W][(window.DAYS||['Lundi','Mardi','Mercredi','Jeudi','Vendredi'])[dayIdx]][targetName])) || isRestAfterGuard(week,dayIdx,targetName);
    }
  }catch(e){}
  if(!absent) return null;

  // pool par spécialité
  var pool=[], loadMap={};
  try{
    if(isIntern){
      pool = seg.spec ? data.interns.filter(function(p){return (p.specs||[]).indexOf(seg.spec)>=0;}).map(function(p){return p.name;}) : (data.interns||[]).map(function(p){return p.name;});
      loadMap = weeklyLoadIntern(week);
    }else{
      pool = seg.spec ? data.practitioners.filter(function(p){return (p.specs||[]).indexOf(seg.spec)>=0;}).map(function(p){return p.name;}) : (data.practitioners||[]).map(function(p){return p.name;});
      loadMap = weeklyLoad(week);
    }
  }catch(e){}

  var currentRep=(function(){var a=getAssignment(week,roomIdx,dayIdx,seg.start);return isIntern?a.repIntern:a.repPrac;})();
  var candidates=[];
  for(var i=0;i<pool.length;i++){
    var name=pool[i];
    if(name===targetName) continue;
    // skip candidate si absent ou repos
    var candAbsent=false;
    try{
      if(isIntern){
        candAbsent = (data.absencesIntern[W] && (data.absencesIntern[W][(window.DAYS||['Lundi','Mardi','Mercredi','Jeudi','Vendredi'])[dayIdx]][name])) || isRestAfterGuardIntern(week,dayIdx,name);
      }else{
        candAbsent = (data.absences[W] && (data.absences[W][(window.DAYS||['Lundi','Mardi','Mercredi','Jeudi','Vendredi'])[dayIdx]][name])) || isRestAfterGuard(week,dayIdx,name);
      }
    }catch(e){}
    if(candAbsent) continue;

    var parallels = isIntern
      ? getParallelSegmentsForIntern(week, name, dayIdx, seg.start, seg.end, roomIdx)
      : getParallelSegmentsForPrac(week, name, dayIdx, seg.start, seg.end, roomIdx);
    candidates.push({name:name, load:loadMap[name]||0, parallels:parallels});
  }
  candidates.sort(function(a,b){
    var afree = a.parallels.length===0, bfree = b.parallels.length===0;
    if(afree!==bfree) return afree? -1: 1;
    var dl=a.load-b.load; if(dl) return dl;
    return a.name.localeCompare(b.name);
  });
  if(!candidates.length) return null;

  var wrap=el('div',null,(isIntern?'Remplacer Interne : ':'Remplacer Chef : '));
  wrap.style.maxHeight='320px'; wrap.style.overflowY='auto'; wrap.style.padding='6px 0';

  // Option "aucun"
  (function(){
    var clearBtn = el('button',{class: 'ghost rep-choice' + (currentRep ? '' : ' selected')}, 'Aucun remplaçant');
    clearBtn.title = 'Réinitialiser le remplacement';
    clearBtn.onclick=function(){
      try{
        clearBtn.classList.add('selected');
        var sib=wrap.querySelectorAll('.rep-choice'); 
        for(var i=0;i<sib.length;i++){ if(sib[i]!==clearBtn) sib[i].classList.remove('selected'); }
      }catch(e){}
      for(var ss=seg.start; ss<seg.end; ss++){
        if(isIntern) setOverride(week, roomIdx, dayIdx, ss, {repIntern:''});
        else setOverride(week, roomIdx, dayIdx, ss, {repPrac:''});
      }
      if(window.refreshActivePage) refreshActivePage(); else if(window.renderAccueil) renderAccueil();
    };
    wrap.appendChild(clearBtn);
    wrap.appendChild(document.createTextNode(' '));
  })();
<script>
/* ====== Planning praticien ====== */
function buildPracSelect(sel){
  try{
    while(sel.firstChild) sel.removeChild(sel.firstChild);
    for(var i=0;i<data.practitioners.length;i++){
      var o=document.createElement('option');
      o.value=data.practitioners[i].name;
      o.text=data.practitioners[i].name;
      sel.appendChild(o);
    }
  }catch(e){}
}

function ppLabelPeriod(sIdx, eIdx){
  function timeLabel(idx){ return (idx<SLOTS.length? SLOTS[idx] : '20:00'); }
  return timeLabel(sIdx)+'–'+timeLabel(eIdx);
}

function renderPracPage(){
  try{ window.refreshActivePage = renderPracPage; }catch(e){}
  var y=$('ppYear'), w=$('ppWeek'), p=$('ppPrac');

  // Controls
  buildYearSelect(y, ui.year);
  y.value = String(ui.year||2025);
  if(!w.value) w.value = String(ui.week||36);
  if(!p.options.length) buildPracSelect(p);
  if(!p.value && data.practitioners.length){ p.value=data.practitioners[0].name; }

  function syncRange(){
    var wk=parseInt(w.value,10)||36, yr=parseInt(y.value,10)||2025;
    $('ppRange').textContent = weekRange(yr, wk);
  }
  syncRange();

  y.onchange=function(){ setWeekYear(parseInt(w.value,10), parseInt(y.value,10)); syncWeekControls(); draw(); };
  w.onchange=function(){ setWeekYear(parseInt(w.value,10), parseInt(y.value,10)); syncWeekControls(); draw(); };
  p.onchange=function(){ draw(); };

  draw();

  function draw(){
    var week=parseInt(w.value,10)||36, year=parseInt(y.value,10)||2025;
    var name=p.value||'';
    ensureWeek(week);
    syncRange();

    // TABLE weekly view
    var out=$('ppOut'); while(out.firstChild) out.removeChild(out.firstChild);
    var tbl=document.createElement('table'); tbl.setAttribute('data-name','Planning '+name+' S'+pad2(week));
    var thead=document.createElement('thead'); var trh=document.createElement('tr');
    ['Jour','Segments'].forEach(function(h){ trh.appendChild(el('th',null,h)); });
    thead.appendChild(trh); tbl.appendChild(thead);
    var tb=document.createElement('tbody');

    // Helpers
    function isAbsentDay(dayIdx){
      try{ return !!(data.absences[String(week)][DAYS[dayIdx]][name]); }catch(e){ return false; }
    }
    function isRestDay(dayIdx){ return isRestAfterGuard(week, dayIdx, name); }

    for(var d=0; d<5; d++){
      var tr=document.createElement('tr');
      var ddate=weekDates(year,week)[d];
      tr.appendChild(el('td',null,DAYS[d]+' '+pad2(ddate.getDate())+'/'+pad2(ddate.getMonth()+1)));

      var cell=document.createElement('td');

      // Day-level tags: Absence / Repos / Garde / Astreinte
      (function(){
        var dayName=DAYS[d];
        var W=String(week);
        var tags=[];
        if(isAbsentDay(d)) tags.push(el('span',{class:'tag err'},'ABS'));
        if(isRestDay(d)) tags.push(el('span',{class:'tag warn'},'Repos garde'));
        try{
          if(data.guards[W] && data.guards[W][dayName]===name) tags.push(el('span',{class:'tag'},'Garde'));
        }catch(e){}
        try{
          var oc=data.oncalls[W]||{};
          if(oc.RI && oc.RI[dayName]===name) tags.push(el('span',{class:'tag'},'Astreinte RI'));
          if(oc.NRI && oc.NRI[dayName]===name) tags.push(el('span',{class:'tag'},'Astreinte NRI'));
        }catch(e){}
        if(tags.length){
          var wrap=document.createElement('div');
          for(var t=0;t<tags.length;t++){ wrap.appendChild(tags[t]); wrap.appendChild(document.createTextNode(' ')); }
          cell.appendChild(wrap);
        }
      })();

      // Collect segments across all rooms for this practitioner
      var segs=[];
      for(var ri=0; ri<data.rooms.length; ri++){
        var room = data.rooms[ri];
        var s=0;
        while(s<SLOTS.length){
          var a=getAssignment(week,ri,d,s);
          var base=a.prac||'';
          var rep = a.repPrac||'';
          var role=null; var info=null;
          if(base===name){
            if(rep && rep!==name){ role='remplacé'; info=rep; }
            else { role='titulaire'; }
          } else if(rep===name){
            role='remplaçant'; info=base||'—';
          } else {
            s++; continue;
          }
          // extend
          var e=s+1;
          while(e<SLOTS.length){
            var b=getAssignment(week,ri,d,e);
            var bbase=b.prac||''; var brep=b.repPrac||'';
            var brole=null; var binfo=null;
            if(bbase===name){
              if(brep && brep!==name){ brole='remplacé'; binfo=brep; }
              else { brole='titulaire'; }
            } else if(brep===name){
              brole='remplaçant'; binfo=bbase||'—';
            } else { break; }
            if(brole!==role) break;
            // keep same room & spec to merge for titulaire/remplacements
            if((b.spec||'')!==(a.spec||'')) break;
            e++;
          }
          segs.push({
            start:s, end:e, spec:a.spec||'', room:room.name,
            role:role, info:info, intern: (a.intern||''), ri:ri
          });
          s=e;
        }
      }

      if(!segs.length){
        cell.appendChild(el('span',{class:'muted'},'—'));
      }else{
        // Order by start time
        segs.sort(function(A,B){ return (A.start - B.start) || (A.ri - B.ri); });
        for(var j=0;j<segs.length;j++){
          (function(seg){
            var line=el('div',{class:'segment'});
            line.style.borderLeft='6px solid '+specColor(seg.spec||'');
            var dot=el('span',{class:'dot'}); dot.style.background=specColor(seg.spec||''); line.appendChild(dot);
            var txt = ppLabelPeriod(seg.start, seg.end)+' · '+(seg.spec||'—')+' · '+seg.room;
            var body=el('span',{class:'body'}, txt);
            line.appendChild(body);
            // Role tags
            if(seg.role==='titulaire'){
              line.appendChild(el('span',{class:'tag'},'Titulaire'));
            }else if(seg.role==='remplaçant'){
              line.appendChild(el('span',{class:'tag'},'Remplaçant pour '+seg.info));
            }else if(seg.role==='remplacé'){
              line.appendChild(el('span',{class:'tag warn'},'Remplacé par '+seg.info));
            }
            // Absence/rest tags if relevant
            if(isAbsentDay(d)) line.appendChild(el('span',{class:'tag err'},'ABS'));
            if(isRestDay(d))  line.appendChild(el('span',{class:'tag warn'},'Repos'));
            cell.appendChild(line);
          })(segs[j]);
        }
      }

      tr.appendChild(cell);
      tb.appendChild(tr);
    }
    tbl.appendChild(tb);
    var wrap=document.createElement('div'); wrap.className='table'; wrap.appendChild(tbl);
    out.appendChild(wrap);

    // Guards & Oncalls summary
    var ga=$('ppGA'); while(ga.firstChild) ga.removeChild(ga.firstChild);
    var tbl2=document.createElement('table'); var thead2=document.createElement('thead'); var tr2=document.createElement('tr');
    ['Type','Lun','Mar','Mer','Jeu','Ven','Sam','Dim'].forEach(function(h){ tr2.appendChild(el('th',null,h)); });
    thead2.appendChild(tr2); tbl2.appendChild(thead2);
    var tb2=document.createElement('tbody');

    function rowFor(label, getter){
      var tr=document.createElement('tr'); tr.appendChild(el('td',null,label));
      for(var di=0; di<7; di++){
        var dn = GUARD_DAYS[di];
        var val = getter(dn);
        var td=document.createElement('td');
        td.appendChild(el('span',null, val ? 'Oui' : '—'));
        tr.appendChild(td);
      }
      return tr;
    }
    var W=String(week);
    tb2.appendChild(rowFor('Garde', function(dn){ try{ return data.guards[W] && data.guards[W][dn]===name; }catch(e){ return false; } }));
    tb2.appendChild(rowFor('Astreinte RI', function(dn){ try{ return data.oncalls[W] && data.oncalls[W].RI && data.oncalls[W].RI[dn]===name; }catch(e){ return false; } }));
    tb2.appendChild(rowFor('Astreinte NRI', function(dn){ try{ return data.oncalls[W] && data.oncalls[W].NRI && data.oncalls[W].NRI[dn]===name; }catch(e){ return false; } }));
    tbl2.appendChild(tb2);
    var wrap2=document.createElement('div'); wrap2.className='table'; wrap2.appendChild(tbl2);
    ga.appendChild(wrap2);
  }
}

/* ====== Planning interne ====== */
function buildInternSelect(sel){
  try{
    while(sel.firstChild) sel.removeChild(sel.firstChild);
    for(var i=0;i<data.interns.length;i++){
      var o=document.createElement('option');
      o.value=data.interns[i].name;
      o.text=data.interns[i].name;
      sel.appendChild(o);
    }
  }catch(e){}
}

function renderInternPage(){
  try{ window.refreshActivePage = renderInternPage; }catch(e){}
  var y=$('piYear'), w=$('piWeek'), p=$('piIntern');

  buildYearSelect(y, ui.year);
  y.value = String(ui.year||2025);
  if(!w.value) w.value = String(ui.week||36);
  if(!p.options.length) buildInternSelect(p);
  if(!p.value && data.interns.length){ p.value=data.interns[0].name; }

  function syncRange(){
    var wk=parseInt(w.value,10)||36, yr=parseInt(y.value,10)||2025;
    $('piRange').textContent = weekRange(yr, wk);
  }
  syncRange();

  y.onchange=function(){ setWeekYear(parseInt(w.value,10), parseInt(y.value,10)); syncWeekControls(); draw(); };
  w.onchange=function(){ setWeekYear(parseInt(w.value,10), parseInt(y.value,10)); syncWeekControls(); draw(); };
  p.onchange=function(){ draw(); };

  draw();

  function draw(){
    var week=parseInt(w.value,10)||36, year=parseInt(y.value,10)||2025;
    var name=p.value||'';
    ensureWeek(week);
    syncRange();

    var out=$('piOut'); while(out.firstChild) out.removeChild(out.firstChild);
    var tbl=document.createElement('table'); tbl.setAttribute('data-name','Planning '+name+' S'+pad2(week));
    var thead=document.createElement('thead'); var trh=document.createElement('tr');
    ['Jour','Segments'].forEach(function(h){ trh.appendChild(el('th',null,h)); });
    thead.appendChild(trh); tbl.appendChild(thead);
    var tb=document.createElement('tbody');

    function isAbsentDay(dayIdx){
      try{ return !!(data.absencesIntern[String(week)][DAYS[dayIdx]][name]); }catch(e){ return false; }
    }
    function isRestDay(dayIdx){ return isRestAfterGuardIntern(week, dayIdx, name); }

    for(var d=0; d<5; d++){
      var tr=document.createElement('tr');
      var ddate=weekDates(year,week)[d];
      tr.appendChild(el('td',null,DAYS[d]+' '+pad2(ddate.getDate())+'/'+pad2(ddate.getMonth()+1)));

      var cell=document.createElement('td');

      (function(){
        var dayName=DAYS[d];
        var W=String(week);
        var tags=[];
        if(isAbsentDay(d)) tags.push(el('span',{class:'tag err'},'ABS'));
        if(isRestDay(d)) tags.push(el('span',{class:'tag warn'},'Repos garde'));
        try{
          if(data.guardsIntern[W] && data.guardsIntern[W][dayName]===name) tags.push(el('span',{class:'tag'},'Garde'));
        }catch(e){}
        if(tags.length){
          var wrap=document.createElement('div');
          for(var t=0;t<tags.length;t++){ wrap.appendChild(tags[t]); wrap.appendChild(document.createTextNode(' ')); }
          cell.appendChild(wrap);
        }
      })();

      // Collect segments across all rooms for this intern
      var segs=[];
      for(var ri=0; ri<data.rooms.length; ri++){
        var room = data.rooms[ri];
        var s=0;
        while(s<SLOTS.length){
          var a=getAssignment(week,ri,d,s);
          var base=a.intern||'';
          var rep = a.repIntern||'';
          var role=null; var info=null;
          if(base===name){
            if(rep && rep!==name){ role='remplacé'; info=rep; }
            else { role='titulaire'; }
          } else if(rep===name){
            role='remplaçant'; info=base||'—';
          } else {
            s++; continue;
          }
          var e=s+1;
          while(e<SLOTS.length){
            var b=getAssignment(week,ri,d,e);
            var bbase=b.intern||''; var brep=b.repIntern||'';
            var brole=null; var binfo=null;
            if(bbase===name){
              if(brep && brep!==name){ brole='remplacé'; binfo=brep; }
              else { brole='titulaire'; }
            } else if(brep===name){
              brole='remplaçant'; binfo=bbase||'—';
            } else { break; }
            if(brole!==role) break;
            if((b.spec||'')!==(a.spec||'')) break;
            e++;
          }
          segs.push({
            start:s, end:e, spec:a.spec||'', room:room.name,
            role:role, info:info, prac: (a.prac||''), ri:ri
          });
          s=e;
        }
      }

      if(!segs.length){
        cell.appendChild(el('span',{class:'muted'},'—'));
      }else{
        segs.sort(function(A,B){ return (A.start - B.start) || (A.ri - B.ri); });
        function timeLabel(idx){ return (idx<SLOTS.length? SLOTS[idx] : '20:00'); }
        for(var j=0;j<segs.length;j++){
          (function(seg){
            var line=el('div',{class:'segment'});
            line.style.borderLeft='6px solid '+specColor(seg.spec||'');
            var dot=el('span',{class:'dot'}); dot.style.background=specColor(seg.spec||''); line.appendChild(dot);
            var txt = timeLabel(seg.start)+'–'+timeLabel(seg.end)+' · '+(seg.spec||'—')+' · '+seg.room;
            var body=el('span',{class:'body'}, txt);
            line.appendChild(body);
            if(seg.role==='titulaire'){
              line.appendChild(el('span',{class:'tag'},'Titulaire'));
            }else if(seg.role==='remplaçant'){
              line.appendChild(el('span',{class:'tag'},'Remplaçant pour '+seg.info));
            }else if(seg.role==='remplacé'){
              line.appendChild(el('span',{class:'tag warn'},'Remplacé par '+seg.info));
            }
            if(isAbsentDay(d)) line.appendChild(el('span',{class:'tag err'},'ABS'));
            if(isRestDay(d))  line.appendChild(el('span',{class:'tag warn'},'Repos'));
            cell.appendChild(line);
          })(segs[j]);
        }
      }

      tr.appendChild(cell);
      tb.appendChild(tr);
    }
    tbl.appendChild(tb);
    var wrap=document.createElement('div'); wrap.className='table'; wrap.appendChild(tbl);
    out.appendChild(wrap);

    // Guards summary
    var ga=$('piGA'); while(ga.firstChild) ga.removeChild(ga.firstChild);
    var tbl2=document.createElement('table'); var thead2=document.createElement('thead'); var tr2=document.createElement('tr');
    ['Type','Lun','Mar','Mer','Jeu','Ven','Sam','Dim'].forEach(function(h){ tr2.appendChild(el('th',null,h)); });
    thead2.appendChild(tr2); tbl2.appendChild(thead2);
    var tb2=document.createElement('tbody');

    function rowFor(label, getter){
      var tr=document.createElement('tr'); tr.appendChild(el('td',null,label));
      for(var di=0; di<7; di++){
        var dn = GUARD_DAYS[di];
        var val = getter(dn);
        var td=document.createElement('td');
        td.appendChild(el('span',null, val ? 'Oui' : '—'));
        tr.appendChild(td);
      }
      return tr;
    }
    var W=String(week);
    tb2.appendChild(rowFor('Garde', function(dn){ try{ return data.guardsIntern[W] && data.guardsIntern[W][dn]===name; }catch(e){ return false; } }));
    tbl2.appendChild(tb2);
    var wrap2=document.createElement('div'); wrap2.className='table'; wrap2.appendChild(tbl2);
    ga.appendChild(wrap2);
  }
}

/* ====== Accueil ====== */
function renderAccueil(){
  var y=$('accYear'), wk=$('accWeek'), checks=$('roomChecks'), out=$('accOut');
  buildYearSelect(y, ui.year); buildWeeks(wk, y.value, ui.week); y.value=String(ui.year); wk.value=String(ui.week);

  // Month selectors
  var my=$('accMonthYear'); buildYearSelect(my, 2025);
  $('accMonth').value='7'; // Août 2025

  // Rooms
  clear(checks);
  var roomBoxes=buildCheckList(checks, data.rooms.map(function(r){return r.name;}), true);
  // Allow individual toggle to refresh view
  for (var i=0; i<roomBoxes.length; i++) {
    (function(box){ box.el.onchange = function(){ draw(); }; })(roomBoxes[i]);
  }

  // Filters
  var specBoxes=buildCheckList($('fSpecBox'), data.specialties, true);
  for (var i=0; i<specBoxes.length; i++) {
    (function(box){ box.el.onchange = function(){ draw(); }; })(specBoxes[i]);
  }

  var pracBoxes=buildCheckList($('fPracBox'), data.practitioners, true);
  for (var i=0; i<pracBoxes.length; i++) {
    (function(box){ box.el.onchange = function(){ draw(); }; })(pracBoxes[i]);
  }

  // Buttons
  $('btnAllRooms').onclick=function(){ for(var i=0;i<roomBoxes.length;i++) roomBoxes[i].el.checked=true; draw(); };
  $('btnNoneRooms').onclick=function(){ for(var i=0;i<roomBoxes.length;i++) roomBoxes[i].el.checked=false; draw(); };
  y.onchange=function(){ buildWeeks(wk, y.value, ui.week); setWeekYear(parseInt(wk.value,10), parseInt(y.value,10)); syncWeekControls(); draw(); };
  wk.onchange=function(){ setWeekYear(parseInt(wk.value,10), parseInt(y.value,10)); syncWeekControls(); draw(); };
  $('accMonth').onchange=draw;
  my.onchange=draw;
  for(var i=0;i<specBoxes.length;i++) specBoxes[i].el.onchange=draw;
  for(var i=0;i<pracBoxes.length;i++) pracBoxes[i].el.onchange=draw;

  // Mode
  function setMode(mode){
    $('accModeWeek').className = (mode==='week'?'active':'');
    $('accModeMonth').className = (mode==='month'?'active':'');
    $('blkWeek').className = 'item'+(mode==='week'?'':' hidden');
    $('blkMonth').className = 'item'+(mode==='month'?'':' hidden');
    updateBadge();
    draw();
  }
  $('accModeWeek').onclick=function(){ setMode('week'); };
  $('accModeMonth').onclick = null; // (désactivé – garder semaine)

  // Export
  $('btnExportAccueil').onclick=function(){
    var firstTable=out.querySelector('table'); if(!firstTable){ alert('Aucun tableau à exporter'); return; }
    exportTableCSV(firstTable, 'Accueil_'+(new Date().toISOString().slice(0,10))+'.csv');
  };

  function draw(){
    clear(out);
    var mode = 'week';
    var activeRooms=selectedFromBoxes(roomBoxes, function(n){ return n; });
    var activeSpecs=selectedFromBoxes(specBoxes, function(s){ return s; });
    var activePracs=selectedFromBoxes(pracBoxes, function(p){ return p.name; });

    if(mode==='week'){
      var week=parseInt(wk.value,10), year=parseInt(y.value,10);
      ensureWeek(week);
      for(var ri=0; ri<data.rooms.length; ri++){
        (function(roomIdx){
          var rname=data.rooms[roomIdx].name;
          if(activeRooms.indexOf(rname)<0) return;
          var card=el('div',{class:'card'});
          card.appendChild(el('div',{class:'card-h'}, rname+' — S'+pad2(week)));
          var bd=el('div',{class:'card-b'});
          var tbl=document.createElement('table'); var thead=document.createElement('thead'); var trh=document.createElement('tr');
          tbl.setAttribute('data-name', rname+' S'+pad2(week));
          ['Jour','Segments','Actions'].forEach(function(h){ trh.appendChild(el('th',null,h)); }); thead.appendChild(trh); tbl.appendChild(thead);
          var tb=document.createElement('tbody');
          for(var d=0; d<5; d++){
            var tr=document.createElement('tr'); var ddate=weekDates(year,week)[d]; tr.appendChild(el('td',null,DAYS[d]+' '+fmtDate(ddate)));
            var segs=[], s=0;
            while(s<SLOTS.length){
              var a=getAssignment(week,roomIdx,d,s);
              if(!a.prac && !a.spec && !a.intern){ s++; continue; }
              // filter
              if(activeSpecs.length && a.spec && activeSpecs.indexOf(a.spec)<0){ s++; continue; }
              if(activePracs.length && a.prac && activePracs.indexOf(a.prac)<0){ s++; continue; }
              var key=(a.spec||'')+'|'+(a.prac||'')+'|'+(a.intern||'');
              var e=s+1; while(e<SLOTS.length){ var b=getAssignment(week,roomIdx,d,e); var k2=(b.spec||'')+'|'+(b.prac||'')+'|'+(b.intern||''); if(k2!==key) break; e++; }
              segs.push({start:s,end:e,spec:a.spec,prac:a.prac,intern:a.intern}); s=e;
            }
            var tdSeg=document.createElement('td');
            if(!segs.length) tdSeg.appendChild(el('span',{class:'muted'},'—'));
            for(var j=0;j<segs.length;j++){
              (function(seg){
                var line=el('div',{class:'segment'});
                line.style.borderLeft='6px solid '+specColor(seg.spec||'');
                var dot=el('span',{class:'dot'}); dot.style.background=specColor(seg.spec||''); line.appendChild(dot);
                var period=SLOTS[seg.start]+'–'+(seg.end<SLOTS.length? SLOTS[seg.end]:'20:00');
                var body=el('span',{class:'body'}, period+' · '+(seg.spec||'—')+' · '+(seg.prac||'—')+(seg.intern?(' / '+seg.intern):''));
                line.appendChild(body);
                // Replacement tags (keep absent displayed; add chosen replacement)
                var Wtag=String(week);
                var ovCell = data.overrides[Wtag] && data.overrides[Wtag][roomIdx] && data.overrides[Wtag][roomIdx][d] && data.overrides[Wtag][roomIdx][d][seg.start];
                var repP = ovCell && (ovCell.repPrac || ovCell.prac) || '';
                var repI = ovCell && (ovCell.repIntern || ovCell.intern) || '';
                var pAbs=seg.prac && (data.absences[String(week)][DAYS[d]][seg.prac] || isRestAfterGuard(week,d,seg.prac));
                var iAbs=seg.intern && (data.absencesIntern[String(week)][DAYS[d]][seg.intern] || isRestAfterGuardIntern(week,d,seg.intern));
                if(pAbs) line.appendChild(el('span',{class:'tag err'},'Chef ABS/repos'));
                if(iAbs) line.appendChild(el('span',{class:'tag warn'},'Interne ABS/repos'));
                if(pAbs){
                  line.appendChild(el('span',{class:'tag'}, 'Remplaçant : '+(repP||'Aucun')));
                } else if(repP){
                  line.appendChild(el('span',{class:'tag'}, 'Remplaçant : '+repP));
                }
                if(iAbs){
                  line.appendChild(el('span',{class:'tag'}, 'Remplaçant int. : '+(repI||'Aucun')));
                } else if(repI){
                  line.appendChild(el('span',{class:'tag'}, 'Remplaçant int. : '+repI));
                }
                tdSeg.appendChild(line);
              })(segs[j]);
            }
            tr.appendChild(tdSeg);

            var tdAct=document.createElement('td');
            for(var j=0;j<segs.length;j++){
              (function(seg){
                var uiChef = buildReplacementUI(false, seg, roomIdx, d, week);
                if(uiChef) tdAct.appendChild(uiChef);
                var uiInt = buildReplacementUI(true, seg, roomIdx, d, week);
                if(uiInt) tdAct.appendChild(uiInt);
              })(segs[j]);
            }
            tr.appendChild(tdAct);

            tb.appendChild(tr);
          }
          tbl.appendChild(tb);
          var wrap=document.createElement('div'); wrap.className='table'; wrap.appendChild(tbl); bd.appendChild(wrap); card.appendChild(bd); out.appendChild(card);
        })(ri);
      }
      // CINAPS S+1
      var nextW=Math.min(53, parseInt(wk.value,10)+1); ensureWeek(nextW);
      var list=[];
      for(var i=0;i<data.practitioners.length;i++){
        var p=data.practitioners[i]; if(!p.cinaps) continue;
        var days=0; for(var d=0; d<5; d++){ if(!data.absences[String(nextW)][DAYS[d]][p.name] && !isRestAfterGuard(nextW,d,p.name)) days++; }
        if(days>0) list.push(p.name+' ('+days+'/5)');
      }
      $('cinapsOut').textContent = list.length? list.join(', ') : '—';
      return;
    }

    if(mode==='month'){
      var m=parseInt($('accMonth').value,10), yv=parseInt(my.value,10);
      var boxesRoom=roomBoxes;
      for(var ri=0; ri<boxesRoom.length; ri++){
        var rname=boxesRoom[ri].item; if(!boxesRoom[ri].el.checked) continue;
        (function(roomName){
          var roomIdx=data.rooms.findIndex(function(r){return r.name===roomName;});
          var card=el('div',{class:'card'});
          card.appendChild(el('div',{class:'card-h'}, roomName+' — '+pad2(m+1)+'/'+yv));
          var bd=el('div',{class:'card-b'});
          // Build per week rows (Mon..Fri) with counts
          var tbl=document.createElement('table'); tbl.setAttribute('data-name', roomName+' '+pad2(m+1)+'-'+yv);
          var thead=document.createElement('thead'); var trh=document.createElement('tr');
          ['Semaine','Lun','Mar','Mer','Jeu','Ven'].forEach(function(h){ trh.appendChild(el('th',null,h)); }); thead.appendChild(trh); tbl.appendChild(thead);
          var tb=document.createElement('tbody');

          // calendar iterate weeks rows
          var first=new Date(yv,m,1), last=new Date(yv,m+1,0);
          var start=new Date(first); start.setDate(first.getDate()-((first.getDay()+6)%7));
          var cur=new Date(start);
          function inMonth(d){ return d.getMonth()===m; }
          while(cur<=last || ((cur.getDay()+6)%7)!==0){
            var week=isoWeekNumber(cur);
            var tr=document.createElement('tr'); tr.appendChild(el('td',null,'S'+pad2(week)));
            for(var d=0; d<5; d++){
              var dayDate=new Date(cur); dayDate.setDate(cur.getDate()+d);
              var td=document.createElement('td');
              if(!inMonth(dayDate)){ td.appendChild(el('span',{class:'muted'},'—')); tr.appendChild(td); continue; }
              var wd=(dayDate.getDay()+6)%7; // 0..6
              // aggregate slots for filters
              var cnt=0, bySpec={};
              for(var s=0; s<SLOTS.length; s++){
                var a=data.rooms[roomIdx].schedule[wd][s];
                if(!a.prac && !a.spec && !a.intern) continue;
                if(activeSpecs.length && a.spec && activeSpecs.indexOf(a.spec)<0) continue;
                if(activePracs.length && a.prac && activePracs.indexOf(a.prac)<0) continue;
                cnt++;
                if(a.spec){ bySpec[a.spec]=(bySpec[a.spec]||0)+1; }
              }
              var txt=fmtDate(dayDate)+' · '+cnt+' h';
              td.appendChild(document.createTextNode(txt));
              // chips by spec with colors
              var specs=Object.keys(bySpec).sort();
              for(var k=0;k<specs.length;k++){
                var chip=el('span',{class:'chip'});
                var sw=el('span',{class:'sw'}); sw.style.background=specColor(specs[k]); chip.appendChild(sw);
                chip.appendChild(document.createTextNode(specs[k]+' '+bySpec[specs[k]]+'h'));
                td.appendChild(document.createTextNode(' ')); td.appendChild(chip);
              }
              tr.appendChild(td);
            }
            tb.appendChild(tr);
            cur.setDate(cur.getDate()+7);
          }

          tbl.appendChild(tb);
          var wrap=document.createElement('div'); wrap.className='table'; wrap.appendChild(tbl); bd.appendChild(wrap); card.appendChild(bd); out.appendChild(card);
        })(rname);
      }
      $('cinapsOut').textContent='—';
    }
  }

  // init
  $('accModeWeek').click(); // set mode week then draw
}

/* ====== Calendar Tab ====== */
function renderCalendar(){
  var ySel=$('calYear'); buildYearSelect(ySel, 2025); $('calMonth').value='7';

  // Build filters
  var roomBoxes=buildCheckList($('calRoomChecks'), data.rooms.map(function(r){return r.name;}), true);
  var specBoxes=buildCheckList($('calSpecBox'), data.specialties, true);
  var pracBoxes=buildCheckList($('calPracBox'), data.practitioners, true);
  var intBoxes = buildCheckList($('calIntBox'), data.interns, true);

  // Toggle for Présences / Absences
  function setShowMode(mode){
    $('calModePresence').className = (mode==='presence'?'active':'');
    $('calModeAbsence').className = (mode==='absence'?'active':'');
    draw();
  }
  if ($('calModePresence')) $('calModePresence').onclick = function(){ setShowMode('presence'); };
  if ($('calModeAbsence')) $('calModeAbsence').onclick = function(){ setShowMode('absence'); };
  function currentMode(){ return ($('calModeAbsence') && $('calModeAbsence').className.indexOf('active')>=0)? 'absence':'presence'; }

  // Toggle for Population (Praticiens / Internes / Les deux)
  function setWho(mode){
    $('calWhoPrac').className  = (mode==='prac' ? 'active' : '');
    $('calWhoIntern').className= (mode==='intern' ? 'active' : '');
    $('calWhoBoth').className  = (mode==='both' ? 'active' : '');
    draw();
  }
  if ($('calWhoPrac'))   $('calWhoPrac').onclick   = function(){ setWho('prac'); };
  if ($('calWhoIntern')) $('calWhoIntern').onclick = function(){ setWho('intern'); };
  if ($('calWhoBoth'))   $('calWhoBoth').onclick   = function(){ setWho('both'); };
  function currentWho(){
    if ($('calWhoBoth') && $('calWhoBoth').className.indexOf('active')>=0) return 'both';
    if ($('calWhoIntern') && $('calWhoIntern').className.indexOf('active')>=0) return 'intern';
    return 'prac';
  }

  function draw(){
    var m=parseInt($('calMonth').value,10), y=parseInt($('calYear').value,10);
    var out=$('calOut'); clear(out);
    var head=['Lun','Mar','Mer','Jeu','Ven','Sam','Dim'];
    var row=el('div',{class:'cal'});
    for(var i=0;i<head.length;i++) row.appendChild(el('div',{class:'hd'}, head[i]));

    var first=new Date(y,m,1), last=new Date(y,m+1,0);
    var start=new Date(first); start.setDate(first.getDate()-((first.getDay()+6)%7));
    var cur=new Date(start);

    while(cur<=last || ((cur.getDay()+6)%7)!==0){
      for(var d=0; d<7; d++){
        (function(date){
          var cell=el('div',{class:'cell'});
          cell.appendChild(el('div',{class:'dt'}, pad2(date.getDate())+'/'+pad2(m+1)));

          var mode = currentMode();
          var who  = currentWho();
          var wd=(date.getDay()+6)%7; // 0..6, 0=Mon
          var inMonth = (date.getMonth()===m);

          // Active filters
          var activeRooms = selectedFromBoxes(roomBoxes, function(x){return x;});
          var activeSpecs = selectedFromBoxes(specBoxes, function(x){return x;});
          var activePracs = selectedFromBoxes(pracBoxes, function(x){return x.name;});
          var activeInts  = selectedFromBoxes(intBoxes,  function(x){return x.name;});

          if(inMonth && wd<5){
            if(mode==='presence'){
              // Aggregate PRESENCE per person (hours) on selected rooms/specs
              var byPrac={}, byInt={};

              // Determine ISO week to consider absences & rest after guard
              var wk = isoWeekNumber(date);
              ensureWeek(wk);

              for(var rbi=0; rbi<activeRooms.length; rbi++){
                var roomName=activeRooms[rbi];
                var ri=data.rooms.findIndex(function(r){return r.name===roomName;});
                if(ri<0) continue;

                for(var s=0; s<SLOTS.length; s++){
                  var a=data.rooms[ri].schedule[wd][s];
                  if(!a.prac && !a.spec && !a.intern) continue;
                  if(activeSpecs.length && a.spec && activeSpecs.indexOf(a.spec)<0) continue;

                  if(who!=='intern' && a.prac){
                    if(activePracs.length && activePracs.indexOf(a.prac)<0) { /* filtered out */ }
                    else if( (data.absences[String(wk)][DAYS[wd]][a.prac]) || isRestAfterGuard(wk, wd, a.prac) ) { /* absent/rest */ }
                    else { byPrac[a.prac]=(byPrac[a.prac]||0)+1; }
                  }

                  if(who!=='prac' && a.intern){
                    if(activeInts.length && activeInts.indexOf(a.intern)<0) { /* filtered out */ }
                    else if( (data.absencesIntern[String(wk)][DAYS[wd]][a.intern]) || isRestAfterGuardIntern(wk, wd, a.intern) ) { /* absent/rest */ }
                    else {
                      // slot spec consistency already filtered by activeSpecs above
                      byInt[a.intern]=(byInt[a.intern]||0)+1;
                    }
                  }
                }
              }

              // Render chips
              if(who!=='intern'){
                var names=Object.keys(byPrac).sort();
                for(var k=0;k<names.length;k++){
                  var chip=el('div',{class:'chip'});
                  var pobj = data.practitioners.find(function(p){return p.name===names[k];});
                  var specForDot = (pobj && pobj.specs && pobj.specs.length)? pobj.specs[0]: '';
                  var sw=el('span',{class:'sw'}); sw.style.background=specColor(specForDot); chip.appendChild(sw);
                  chip.appendChild(document.createTextNode(names[k]+' '+byPrac[names[k]]+'h'));
                  cell.appendChild(chip);
                }
              }

              if(who!=='prac'){
                var namesI=Object.keys(byInt).sort();
                for(var k2=0;k2<namesI.length;k2++){
                  var chipI=el('div',{class:'chip'});
                  var iobj = data.interns.find(function(p){return p.name===namesI[k2];});
                  var specDotI = (iobj && iobj.specs && iobj.specs.length)? iobj.specs[0]: '';
                  var swI=el('span',{class:'sw'}); swI.style.background=specColor(specDotI); chipI.appendChild(swI);
                  chipI.appendChild(document.createTextNode(namesI[k2]+' '+byInt[namesI[k2]]+'h (int.)'));
                  cell.appendChild(chipI);
                }
              }

            } else {
              // ABSENCE mode: list people who are absent or resting after guard on that weekday
              var wk2 = isoWeekNumber(date);
              ensureWeek(wk2);

              if(who!=='intern'){
                var absentList=[];
                for(var p=0; p<activePracs.length; p++){
                  var nm=activePracs[p];
                  var pobj = data.practitioners.find(function(pp){return pp.name===nm;});
                  if(activeSpecs.length){
                    var hasSpec=false;
                    var specsOfP=(pobj && pobj.specs) ? pobj.specs : [];
                    for(var si=0; si<specsOfP.length; si++){ if(activeSpecs.indexOf(specsOfP[si])>=0){ hasSpec=true; break; } }
                    if(!hasSpec) continue;
                  }
                  var isAbs = (data.absences[String(wk2)][DAYS[wd]][nm]) || isRestAfterGuard(wk2, wd, nm);
                  if(isAbs) absentList.push(nm);
                }
                absentList.sort();
                for(var aidx=0; aidx<absentList.length; aidx++){
                  var chipA=el('div',{class:'chip'});
                  var pobj2 = data.practitioners.find(function(pp){return pp.name===absentList[aidx];});
                  var specDot = (pobj2 && pboj2?.specs && pobj2.specs.length)? pobj2.specs[0]: ''; // safe-ish
                  var sw2=el('span',{class:'sw'}); sw2.style.background=specColor(specDot); chipA.appendChild(sw2);
                  chipA.appendChild(document.createTextNode(absentList[aidx]));
                  cell.appendChild(chipA);
                }
              }

              if(who!=='prac'){
                var absentInt=[];
                var selectedIntNames = activeInts.length ? activeInts : data.interns.map(function(i){return i.name;});
                for(var q=0; q<selectedIntNames.length; q++){
                  var nmI=selectedIntNames[q];
                  var iobj = data.interns.find(function(ii){return ii.name===nmI;});
                  if(activeSpecs.length){
                    var hasSpecI=false;
                    var specsI=(iobj && iobj.specs) ? iobj.specs : [];
                    for(var sj=0; sj<specsI.length; sj++){ if(activeSpecs.indexOf(specsI[sj])>=0){ hasSpecI=true; break; } }
                    if(!hasSpecI) continue;
                  }
                  var isAbsI = (data.absencesIntern[String(wk2)][DAYS[wd]][nmI]) || isRestAfterGuardIntern(wk2, wd, nmI);
                  if(isAbsI) absentInt.push(nmI);
                }
                absentInt.sort();
                for(var a2=0; a2<absentInt.length; a2++){
                  var chipAI=el('div',{class:'chip'});
                  var iobj2 = data.interns.find(function(ii){return ii.name===absentInt[a2];});
                  var specDotI2 = (iobj2 && iobj2.specs && iobj2.specs.length)? iobj2.specs[0]: '';
                  var swI2=el('span',{class:'sw'}); swI2.style.background=specColor(specDotI2); chipAI.appendChild(swI2);
                  chipAI.appendChild(document.createTextNode(absentInt[a2]+' (int.)'));
                  cell.appendChild(chipAI);
                }
              }
            }
          }

          row.appendChild(cell);
        })(new Date(cur));
        cur.setDate(cur.getDate()+1);
      }
    }
    out.appendChild(row);
  }

  $('calMonth').onchange=draw; $('calYear').onchange=draw;
  for(var i=0;i<roomBoxes.length;i++) roomBoxes[i].el.onchange=draw;
  for(var i=0;i<specBoxes.length;i++) specBoxes[i].el.onchange=draw;
  for(var i=0;i<pracBoxes.length;i++) pracBoxes[i].el.onchange=draw;
  for(var i=0;i<intBoxes.length;i++) intBoxes[i].el.onchange=draw;
  draw();
}

/* ====== Absences & Remplacements Tab ====== */
/* (⚠️ on NE redéfinit PAS refreshActivePage ici pour éviter une récursion) */
function renderAbsRep(){
  var ySel = $('absrepYear'); buildYearSelect(ySel, ui.year); ySel.value=String(ui.year); var wInp = $('absrepWeek'); wInp.value = String(ui.week);
  var out  = $('absrepOut');
  var range = $('absrepRange');

  // Build filters (once per render to reflect new rooms/specs)
  var roomBoxes = buildCheckList($('absrepRoomChecks'), data.rooms.map(function(r){return r.name;}), true);
  var specBoxes = buildCheckList($('absrepSpecBox'), data.specialties, true);

  // Who toggle
  function setWho(mode){
    $('absrepWhoBoth').className   = (mode==='both' ? 'active' : '');
    $('absrepWhoPrac').className   = (mode==='prac' ? 'active' : '');
    $('absrepWhoIntern').className = (mode==='intern' ? 'active' : '');
    draw();
  }
  $('absrepWhoBoth').onclick = function(){ setWho('both'); };
  $('absrepWhoPrac').onclick = function(){ setWho('prac'); };
  $('absrepWhoIntern').onclick = function(){ setWho('intern'); };
  function currentWho(){
    if ($('absrepWhoPrac').className.indexOf('active')>=0) return 'prac';
    if ($('absrepWhoIntern').className.indexOf('active')>=0) return 'intern';
    return 'both';
  }

  // Events
  ySel.onchange = function(){ setWeekYear(parseInt(wInp.value,10), parseInt(ySel.value,10)); syncWeekControls(); draw(); };
  wInp.onchange = function(){ setWeekYear(parseInt(wInp.value,10), parseInt(ySel.value,10)); syncWeekControls(); draw(); };
  for (var i=0;i<roomBoxes.length;i++) roomBoxes[i].el.onchange = draw;
  for (var j=0;j<specBoxes.length;j++) specBoxes[j].el.onchange = draw;

  // Export
  $('btnExportAbsRep').onclick = function(){
    var tbl = out.querySelector('table');
    if(!tbl){ alert('Aucun tableau à exporter'); return; }
    exportTableCSV(tbl, 'Absences_Remplacements_'+(new Date().toISOString().slice(0,10))+'.csv');
  };

  function draw(){
    clear(out);
    var year = parseInt(ySel.value,10);
    var week = parseInt(wInp.value,10) || 36;
    ensureWeek(week);
    range.textContent = 'S'+(week<10?('0'+week):week)+' · '+year;

    var activeRooms = selectedFromBoxes(roomBoxes, function(n){return n;});
    var activeSpecs = selectedFromBoxes(specBoxes, function(s){return s;});
    var who = currentWho();

    // Build a summary table: one row per absent segment (prac and/or intern)
    var tbl=document.createElement('table');
    var thead=document.createElement('thead');
    var trh=document.createElement('tr');
    ['Jour','Heure','Salle','Spécialité','Chef','Interne','Actions'].forEach(function(h){ trh.appendChild(el('th',null,h)); });
    thead.appendChild(trh); tbl.appendChild(thead);
    var tb=document.createElement('tbody');

    for (var ri=0; ri<data.rooms.length; ri++){
      var roomName = data.rooms[ri].name;
      if (activeRooms.length && activeRooms.indexOf(roomName)<0) continue;

      for (var d=0; d<5; d++){
        // Build coalesced segments exactly like Accueil (by spec/prac/intern identity)
        var s=0;
        while(s<SLOTS.length){
          var a=getAssignment(week,ri,d,s);
          if(!a.prac && !a.spec && !a.intern){ s++; continue; }

          // Filter by spec
          if(activeSpecs.length && a.spec && activeSpecs.indexOf(a.spec)<0){ s++; continue; }

          var key=(a.spec||'')+'|'+(a.prac||'')+'|'+(a.intern||'');
          var e=s+1; while(e<SLOTS.length){
            var b=getAssignment(week,ri,d,e);
            var k2=(b.spec||'')+'|'+(b.prac||'')+'|'+(b.intern||'');
            if(k2!==key) break; e++;
          }
          var seg={start:s,end:e,spec:a.spec,prac:a.prac,intern:a.intern};

          var pAbs = seg.prac && (data.absences[String(week)][DAYS[d]][seg.prac] || isRestAfterGuard(week,d,seg.prac));
          var iAbs = seg.intern && (data.absencesIntern[String(week)][DAYS[d]][seg.intern] || isRestAfterGuardIntern(week,d,seg.intern));

          // Only list rows where there is an absence matching the selected population
          var showPrac = (who!=='intern') && pAbs;
          var showInt  = (who!=='prac')   && iAbs;
          if (!showPrac && !showInt){ s=e; continue; }

          var tr=document.createElement('tr');

          // Jour
          tr.appendChild(el('td',null, DAYS[d]));
          // Heure
          var period=SLOTS[seg.start]+'–'+(seg.end<SLOTS.length? SLOTS[seg.end]:'20:00');
          tr.appendChild(el('td',null, period));
          // Salle
          tr.appendChild(el('td',null, roomName));
          // Spécialité
          tr.appendChild(el('td',null, seg.spec||'—'));

          // Chef
          var tdChef=document.createElement('td');
          if(seg.prac){
            var c = seg.prac + (pAbs? ' (ABS/repos)':'');
            tdChef.appendChild(document.createTextNode(c));
          } else tdChef.appendChild(el('span',{class:'muted'}, '—'));
          tr.appendChild(tdChef);

          // Interne
          var tdInt=document.createElement('td');
          if(seg.intern){
            var ci = seg.intern + (iAbs? ' (ABS/repos)':'');
            tdInt.appendChild(document.createTextNode(ci));
          } else tdInt.appendChild(el('span',{class:'muted'}, '—'));
          tr.appendChild(tdInt);

          // Actions
          var tdAct=document.createElement('td');
          if (showPrac){
            var uiChef = buildReplacementUI(false, seg, ri, d, week);
            if(uiChef) tdAct.appendChild(uiChef);
          }
          if (showInt){
            var uiInt = buildReplacementUI(true, seg, ri, d, week);
            if(uiInt) tdAct.appendChild(uiInt);
          }
          if(!tdAct.firstChild) tdAct.appendChild(el('span',{class:'muted'}, '—'));
          tr.appendChild(tdAct);

          tb.appendChild(tr);
          s=e; // advance
        }
      }
    }

    // If no rows added
    if(!tb.firstChild){
      var tr0=document.createElement('tr');
      var td0=document.createElement('td'); td0.colSpan=7; td0.appendChild(document.createTextNode('Aucune absence sur la sélection.'));
      tr0.appendChild(td0); tb.appendChild(tr0);
    }

    tbl.appendChild(tb);
    clear(out);
    var wrap=document.createElement('div'); wrap.className='table'; wrap.appendChild(tbl);
    out.appendChild(wrap);
  }

  // Initial draw
  draw();
}

/* ====== Week Type (with Spec↔Room constraint) ====== */
function populateSelect(sel, arr, withEmpty){
  clear(sel);
  if(withEmpty){ var e=document.createElement('option'); e.value=''; e.text='—'; sel.appendChild(e); }
  for(var i=0;i<arr.length;i++){ var o=document.createElement('option'); var v=arr[i]; o.value=(typeof v==='string'? v: v.name); o.text=(typeof v==='string'? v: v.name); sel.appendChild(o); }
}
function renderWeekType(){
  var r=$('wtRoom'), d=$('wtDay'), grid=$('wtGrid'), s0=$('fStart'), s1=$('fEnd');
  clear(r); for(var i=0;i<data.rooms.length;i++){ r.appendChild(el('option',{value:String(i)}, data.rooms[i].name)); }
  clear(d); for(var j=0;j<5;j++){ d.appendChild(el('option',{value:String(j)}, DAYS[j])); }
  clear(s0); clear(s1);
  for(var k=0;k<SLOTS.length;k++){ s0.appendChild(el('option',{value:String(k)}, SLOTS[k])); }
  for(var k2=1;k2<=SLOTS.length;k2++){ s1.appendChild(el('option',{value:String(k2)}, (k2<SLOTS.length? SLOTS[k2]:'20:00'))); }
  populateSelect($('fSpec'), data.specialties, false);
  populateSelect($('fPrac'), data.practitioners, true);
  populateSelect($('fIntern'), data.interns, true);

  function updateSpecRoomHint(){
    var ri=parseInt(r.value||'0',10);
    var allow=data.rooms[ri].allow||[];
    $('specRoomHint').textContent = allow.length? ('Spécialités autorisées pour '+data.rooms[ri].name+' : '+allow.join(', ')) : 'Toutes spécialités autorisées (aucune restriction pour cette salle).';
  }
  updateSpecRoomHint();
  r.onchange=function(){ updateSpecRoomHint(); draw(); };
  d.onchange=function(){ draw(); };

  $('fAdd').onclick=function(){
    var ri=parseInt(r.value||'0',10), di=parseInt(d.value||'0',10);
    var spec=$('fSpec').value.trim(), prac=$('fPrac').value.trim(), intern=$('fIntern').value.trim();
    var a0=parseInt(s0.value,10), a1=parseInt(s1.value,10);
    if(!spec){ alert('Spécialité requise'); return; }
    if(!prac && !intern){ alert('Choisir au moins un Chef OU un Interne'); return; }
    if(!(a1>a0)) { alert('Fin doit être > Début'); return; }
    // Enforce Spec↔Room
    var allow=data.rooms[ri].allow||[];
    if(allow.length && allow.indexOf(spec)<0){
      alert('Spécialité « '+spec+' » non autorisée dans la salle « '+data.rooms[ri].name+' ».'); return;
    }
    for(var s=a0; s<a1; s++){ data.rooms[ri].schedule[di][s]={spec:spec,prac:prac,intern:intern}; }
    save(); draw();
  };

  function draw(){
    var ri=parseInt(r.value||'0',10), di=parseInt(d.value||'0',10);
    clear(grid);
    var tbl=document.createElement('table'); var thead=document.createElement('thead'); var trh=document.createElement('tr');
    ['Créneau','Spécialité','Chef','Interne','Action'].forEach(function(h){ trh.appendChild(el('th',null,h)); }); thead.appendChild(trh); tbl.appendChild(thead);
    var tb=document.createElement('tbody');
    var allow=data.rooms[ri].allow||[];
    for(var s=0; s<SLOTS.length; s++){
      (function(si){
        var a=data.rooms[ri].schedule[di][si];
        var tr=document.createElement('tr');
        tr.appendChild(el('td',null,SLOTS[si]+'–'+(si+1<SLOTS.length? SLOTS[si+1]:'20:00')));
        var tdSpec=el('td',null, a.spec||'—');
        if(a.spec){ tdSpec.style.borderLeft='6px solid '+specColor(a.spec); }
        if(a.spec && allow.length && allow.indexOf(a.spec)<0){ tdSpec.appendChild(el('span',{class:'tag err'},'Non autorisée')); }
        tr.appendChild(tdSpec);
        tr.appendChild(el('td',null, a.prac||'—'));
        tr.appendChild(el('td',null, a.intern||'—'));
        var td=document.createElement('td'); var b=el('button',{class:'ghost'},'Vider'); b.onclick=function(){ data.rooms[ri].schedule[di][si]={spec:'',prac:'',intern:''}; save(); draw(); }; td.appendChild(b); tr.appendChild(td);
        tb.appendChild(tr);
      })(s);
    }
    tbl.appendChild(tb); var wrap=document.createElement('div'); wrap.className='table'; wrap.appendChild(tbl); grid.appendChild(wrap);
  }
  draw();
}

/* ====== Absences ====== */
function renderAbs(){
  buildYearSelect($('absYear'), ui.year);
  $('absYear').value=String(ui.year);
  var y=parseInt($('absYear').value,10);
  var w=$('absWeek'); w.value=String(ui.week); ensureWeek(parseInt(w.value,10));
  var dates=weekDates(y, parseInt(w.value,10));
  $('absRange').textContent='S'+pad2(parseInt(w.value,10))+' · '+fmtDate(dates[0])+' → '+fmtDate(dates[4])+' / '+y;
  var cont=$('absTable'); clear(cont);
  var tbl=document.createElement('table'); tbl.setAttribute('data-name','Absences Praticiens S'+pad2(parseInt(w.value,10)));
  var thead=document.createElement('thead'); var trh=document.createElement('tr');
  trh.appendChild(el('th',null,'Praticien'));
  for(var i=0;i<5;i++){ trh.appendChild(el('th',null,DAYS[i]+' '+fmtDate(dates[i]))); }
  thead.appendChild(trh); tbl.appendChild(thead);
  var tb=document.createElement('tbody');
  for(var i=0;i<data.practitioners.length;i++){
    (function(p){
      var tr=document.createElement('tr'); tr.appendChild(el('td',null,p.name));
      for(var d=0; d<5; d++){
        (function(day){
          var on = !!data.absences[String(w.value)][day][p.name];
          var td=document.createElement('td');
          var b=el('button', null, on?'ABS':'Présent');
          if(on){ b.style.background='#351a1a'; b.style.color='#ffdede'; b.style.border='1px solid #6d3232'; }
          b.onclick=function(){ data.absences[String(w.value)][day][p.name]=!on; save(); renderAbs(); };
          td.appendChild(b); tr.appendChild(td);
        })(DAYS[d]);
      }
      tb.appendChild(tr);
    })(data.practitioners[i]);
  }
  tbl.appendChild(tb); cont.appendChild(tbl);
  $('btnExportAbsP').onclick=function(){ exportTableCSV(tbl,'Absences_Praticiens_S'+pad2(parseInt(w.value,10))+'.csv'); };
  $('absYear').onchange=function(){ setWeekYear(parseInt($('absWeek').value,10), parseInt($('absYear').value,10)); renderAbs(); };
  w.onchange=function(){ ensureWeek(parseInt(w.value,10)); setWeekYear(parseInt(w.value,10), parseInt($('absYear').value,10)); renderAbs(); };
}

function renderAbsIntern(){
  buildYearSelect($('absIYear'), ui.year);
  $('absIYear').value=String(ui.year);
  var y=parseInt($('absIYear').value,10);
  var w=$('absIWeek'); w.value=String(ui.week); ensureWeek(parseInt(w.value,10));
  var dates=weekDates(y, parseInt(w.value,10));
  $('absIRange').textContent='S'+pad2(parseInt(w.value,10))+' · '+fmtDate(dates[0])+' → '+fmtDate(dates[4])+' / '+y;
  var cont=$('absITable'); clear(cont);
  var tbl=document.createElement('table'); tbl.setAttribute('data-name','Absences Internes S'+pad2(parseInt(w.value,10)));
  var thead=document.createElement('thead'); var trh=document.createElement('tr');
  trh.appendChild(el('th',null,'Interne'));
  for(var i=0;i<5;i++){ trh.appendChild(el('th',null,DAYS[i]+' '+fmtDate(dates[i]))); }
  thead.appendChild(trh); tbl.appendChild(thead);
  var tb=document.createElement('tbody');
  for(var i=0;i<data.interns.length;i++){
    (function(p){
      var tr=document.createElement('tr'); tr.appendChild(el('td',null,p.name));
      for(var d=0; d<5; d++){
        (function(day){
          var on = !!data.absencesIntern[String(w.value)][day][p.name];
          var td=document.createElement('td');
          var b=el('button', null, on?'ABS':'Présent');
          if(on){ b.style.background='#352e1a'; b.style.color='#ffefde'; b.style.border='1px solid #6d6132'; }
          b.onclick=function(){ data.absencesIntern[String(w.value)][day][p.name]=!on; save(); renderAbsIntern(); };
          td.appendChild(b); tr.appendChild(td);
        })(DAYS[d]);
      }
      tb.appendChild(tr);
    })(data.interns[i]);
  }
  tbl.appendChild(tb); cont.appendChild(tbl);
  $('btnExportAbsI').onclick=function(){ exportTableCSV(tbl,'Absences_Internes_S'+pad2(parseInt(w.value,10))+'.csv'); };
  $('absIYear').onchange=function(){ setWeekYear(parseInt($('absIWeek').value,10), parseInt($('absIYear').value,10)); renderAbsIntern(); };
  w.onchange=function(){ ensureWeek(parseInt(w.value,10)); setWeekYear(parseInt(w.value,10), parseInt($('absIYear').value,10)); renderAbsIntern(); };
}

/* ====== Gardes ====== */
function renderGuards(){
  buildYearSelect($('gdYear'), ui.year);
  $('gdYear').value=String(ui.year);
  var y=parseInt($('gdYear').value,10);
  var w=$('gdWeek'); w.value=String(ui.week); ensureWeek(parseInt(w.value,10));
  var dates=weekDates(y, parseInt(w.value,10));
  $('gdRange').textContent='S'+pad2(parseInt(w.value,10))+' · '+fmtDate(dates[0])+' → '+fmtDate(dates[6])+' / '+y;
  var cont=$('gdTable'); clear(cont);
  var tbl=document.createElement('table'); tbl.setAttribute('data-name','Gardes Praticiens S'+pad2(parseInt(w.value,10)));
  var thead=document.createElement('thead'); var trh=document.createElement('tr');
  trh.appendChild(el('th',null,'Jour')); trh.appendChild(el('th',null,'Praticien de garde'));
  thead.appendChild(trh); tbl.appendChild(thead);
  var tb=document.createElement('tbody');
  for(var i=0;i<GUARD_DAYS.length;i++){
    (function(day, idx){
      var tr=document.createElement('tr'); tr.appendChild(el('td',null,day+' '+fmtDate(dates[idx])));
      var td=document.createElement('td'); var sel=document.createElement('select'); var opt=document.createElement('option'); opt.value=''; opt.text='—'; sel.appendChild(opt);
      for(var p=0;p<data.practitioners.length;p++){ var o=document.createElement('option'); o.value=data.practitioners[p].name; o.text=data.practitioners[p].name; sel.appendChild(o); }
      sel.value=data.guards[String(w.value)][day]||'';
      sel.onchange=function(){ data.guards[String(w.value)][day]=this.value; save(); };
      td.appendChild(sel);
      var absentTag=document.createElement('span'); absentTag.className='tag err'; absentTag.style.marginLeft='8px';absentTag.textContent='ABSENT ce jour';
      absentTag.style.display = isAbsentOnGuardDay(w.value, day, sel.value, false)? '' : 'none';
      td.appendChild(absentTag);
      sel.addEventListener('change', function(){ absentTag.style.display = isAbsentOnGuardDay(w.value, day, sel.value, false)? '' : 'none'; });
      tr.appendChild(td); tb.appendChild(tr);
    })(GUARD_DAYS[i], i);
  }
  tbl.appendChild(tb); cont.appendChild(tbl);
  $('btnExportGdP').onclick=function(){ exportTableCSV(tbl,'Gardes_Praticiens_S'+pad2(parseInt(w.value,10))+'.csv'); };
  $('gdYear').onchange=function(){ setWeekYear(parseInt($('gdWeek').value,10), parseInt($('gdYear').value,10)); renderGuards(); };
  w.onchange=function(){ ensureWeek(parseInt(w.value,10)); setWeekYear(parseInt(w.value,10), parseInt($('gdYear').value,10)); renderGuards(); };
}

function renderGuardsIntern(){
  buildYearSelect($('gdIYear'), ui.year);
  $('gdIYear').value=String(ui.year);
  var y=parseInt($('gdIYear').value,10);
  var w=$('gdIWeek'); w.value=String(ui.week); ensureWeek(parseInt(w.value,10));
  var dates=weekDates(y, parseInt(w.value,10));
  $('gdIRange').textContent='S'+pad2(parseInt(w.value,10))+' · '+fmtDate(dates[0])+' → '+fmtDate(dates[6])+' / '+y;
  var cont=$('gdITable'); clear(cont);
  var tbl=document.createElement('table'); tbl.setAttribute('data-name','Gardes Internes S'+pad2(parseInt(w.value,10)));
  var thead=document.createElement('thead'); var trh=document.createElement('tr');
  trh.appendChild(el('th',null,'Jour')); trh.appendChild(el('th',null,'Interne de garde'));
  thead.appendChild(trh); tbl.appendChild(thead);
  var tb=document.createElement('tbody');
  for(var i=0;i<GUARD_DAYS.length;i++){
    (function(day, idx){
      var tr=document.createElement('tr'); tr.appendChild(el('td',null,day+' '+fmtDate(dates[idx])));
      var td=document.createElement('td'); var sel=document.createElement('select'); var opt=document.createElement('option'); opt.value=''; opt.text='—'; sel.appendChild(opt);
      for(var p=0;p<data.interns.length;p++){ var o=document.createElement('option'); o.value=data.interns[p].name; o.text=data.interns[p].name; sel.appendChild(o); }
      sel.value=data.guardsIntern[String(w.value)][day]||'';
      sel.onchange=function(){ data.guardsIntern[String(w.value)][day]=this.value; save(); };
      td.appendChild(sel);
      var absentTagI=document.createElement('span'); absentTagI.className='tag warn'; absentTagI.style.marginLeft='8px';absentTagI.textContent='INTERNE ABSENT';
      absentTagI.style.display = isAbsentOnGuardDay(w.value, day, sel.value, true)? '' : 'none';
      td.appendChild(absentTagI);
      sel.addEventListener('change', function(){ absentTagI.style.display = isAbsentOnGuardDay(w.value, day, sel.value, true)? '' : 'none'; });
      tr.appendChild(td); tb.appendChild(tr);
    })(GUARD_DAYS[i], i);
  }
  tbl.appendChild(tb); cont.appendChild(tbl);
  $('btnExportGdI').onclick=function(){ exportTableCSV(tbl,'Gardes_Internes_S'+pad2(parseInt(w.value,10))+'.csv'); };
  $('gdIYear').onchange=function(){ setWeekYear(parseInt($('gdIWeek').value,10), parseInt($('gdIYear').value,10)); renderGuardsIntern(); };
  w.onchange=function(){ ensureWeek(parseInt(w.value,10)); setWeekYear(parseInt(w.value,10), parseInt($('gdIYear').value,10)); renderGuardsIntern(); };
}

/* ====== Rename helpers ====== */
/* ====== Specialty flags (tele/cinaps) ====== */
function getSpecFlag(spec, key){
  try{
    if(!data.specFlags) return false;
    var f = data.specFlags[spec];
    if(!f) return false;
    return !!f[key];
  }catch(e){ return false; }
}
function setSpecFlag(spec, key, val){
  try{
    if(!data.specFlags) data.specFlags = {};
    var f = data.specFlags[spec] || {tele:false, cinaps:false};
    f[key] = !!val;
    data.specFlags[spec] = f;
    save();
  }catch(e){}
}

function renameKeyInAbsences(absObj, oldName, newName, dayList){
  try{
    var weeks = Object.keys(absObj||{});
    for(var wi=0; wi<weeks.length; wi++){
      var W = weeks[wi];
      for(var di=0; di<dayList.length; di++){
        var day = dayList[di];
        var line = absObj[W] && absObj[W][day];
        if(!line) continue;
        if(typeof line[newName] === 'undefined'){ line[newName] = false; }
        if(Object.prototype.hasOwnProperty.call(line, oldName)){
          line[newName] = !!line[oldName];
          delete line[oldName];
        }
      }
    }
  }catch(e){}
}
function renameInOverrides(fieldRep, fieldBase, oldName, newName){
  var ovAll = data.overrides || {};
  var weeks = Object.keys(ovAll);
  for(var wi=0; wi<weeks.length; wi++){
    var W = weeks[wi], wObj = ovAll[W] || {};
    var rooms = Object.keys(wObj);
    for(var ri=0; ri<rooms.length; ri++){
      var rObj = wObj[rooms[ri]] || {};
      var days = Object.keys(rObj);
      for(var di=0; di<days.length; di++){
        var dObj = rObj[days[di]] || {};
        var slots = Object.keys(dObj);
        for(var si=0; si<slots.length; si++){
          var cell = dObj[slots[si]] || {};
          if(cell[fieldRep] === oldName) cell[fieldRep] = newName;
          if(cell[fieldBase] === oldName) cell[fieldBase] = newName;
        }
      }
    }
  }
}
function renamePractitioner(oldName, newName){
  // practitioners array
  for(var i=0;i<data.practitioners.length;i++){
    if(data.practitioners[i].name === oldName){ data.practitioners[i].name = newName; break; }
  }
  // schedules
  for(var ri=0; ri<data.rooms.length; ri++){
    for(var d=0; d<5; d++){
      for(var s=0; s<SLOTS.length; s++){
        var a = data.rooms[ri].schedule[d][s];
        if(a && a.prac === oldName) a.prac = newName;
      }
    }
  }
  // overrides
  renameInOverrides('repPrac','prac',oldName,newName);
  // absences + guards
  renameKeyInAbsences(data.absences, oldName, newName, DAYS);
  var weeks = Object.keys(data.guards||{});
  for(var w=0; w<weeks.length; w++){
    var W = weeks[w], g = data.guards[W]||{};
    for(var di=0; di<GUARD_DAYS.length; di++){
      var day = GUARD_DAYS[di];
      if(g[day] === oldName) g[day] = newName;
    }
  }
  save();
}
function renameIntern(oldName, newName){
  for(var i=0;i<data.interns.length;i++){
    if(data.interns[i].name === oldName){ data.interns[i].name = newName; break; }
  }
  for(var ri=0; ri<data.rooms.length; ri++){
    for(var d=0; d<5; d++){
      for(var s=0; s<SLOTS.length; s++){
        var a = data.rooms[ri].schedule[d][s];
        if(a && a.intern === oldName) a.intern = newName;
      }
    }
  }
  renameInOverrides('repIntern','intern',oldName,newName);
  renameKeyInAbsences(data.absencesIntern, oldName, newName, DAYS);
  var weeks = Object.keys(data.guardsIntern||{});
  for(var w=0; w<weeks.length; w++){
    var W = weeks[w], g = data.guardsIntern[W]||{};
    for(var di=0; di<GUARD_DAYS.length; di++){
      var day = GUARD_DAYS[di];
      if(g[day] === oldName) g[day] = newName;
    }
  }
  save();
}
function renameRoom(oldName, newName){
  for(var i=0;i<data.rooms.length;i++){
    if(data.rooms[i].name === oldName){ data.rooms[i].name = newName; break; }
  }
  save();
}
function renameSpecialty(oldName, newName){
  // list
  for(var i=0;i<data.specialties.length;i++){
    if(data.specialties[i] === oldName){ data.specialties[i] = newName; break; }
  }
  // propagate to practitioners / interns
  for(var p=0;p<data.practitioners.length;p++){
    var specs = data.practitioners[p].specs || [];
    for(var k=0;k<specs.length;k++){ if(specs[k]===oldName) specs[k]=newName; }
  }
  for(var q=0;q<data.interns.length;q++){
    var ispecs = data.interns[q].specs || [];
    for(var k2=0;k2<ispecs.length;k2++){ if(ispecs[k2]===oldName) ispecs[k2]=newName; }
  }
  // migrate spec flags
  try{
    if(data.specFlags && data.specFlags[oldName]){
      data.specFlags[newName] = data.specFlags[oldName];
      delete data.specFlags[oldName];
    }
  }catch(e){}
  // rooms allow list + schedules
  for(var ri=0; ri<data.rooms.length; ri++){
    var allow = data.rooms[ri].allow || [];
    for(var ai=0; ai<allow.length; ai++){ if(allow[ai]===oldName) allow[ai]=newName; }
    for(var d=0; d<5; d++){
      for(var s=0; s<SLOTS.length; s++){
        var a = data.rooms[ri].schedule[d][s];
        if(a && a.spec === oldName) a.spec = newName;
      }
    }
  }
  save();
}

/* ====== Données with subtabs ====== */
var DATA_TABS=[['data-prats','Praticiens'],['data-interns','Internes'],['data-rooms','Salles'],['data-specs','Spécialités']];
function renderDataPage(){
  var st=$('dataSubtabs'); clear(st);
  for(var i=0;i<DATA_TABS.length;i++){
    (function(idx){
      var b=document.createElement('button'); b.textContent=DATA_TABS[idx][1];
      b.onclick=function(){ switchDataTab(DATA_TABS[idx][0], b); };
      if(idx===0) b.className='active';
      st.appendChild(b);
    })(i);
  }
  switchDataTab(DATA_TABS[0][0], st.firstChild);
}
function switchDataTab(id, btn){
  for(var i=0;i<DATA_TABS.length;i++){ var sec=$(DATA_TABS[i][0]); if(sec) sec.className = (DATA_TABS[i][0]===id? '':'hidden'); }
  var bs=$('dataSubtabs').children; for(var j=0;j<bs.length;j++){ bs[j].className = (bs[j]===btn? 'active':''); }
  if(id==='data-specs') renderSpecs();
  if(id==='data-prats') renderPracs();
  if(id==='data-interns') renderInterns();
  if(id==='data-rooms') renderRooms();
}

function renderSpecs(){
  var host=$('data-specs'); clear(host);
  var box=el('div', {class:'card-b'});
  var add=el('div', {class:'grid g3'});
  add.appendChild(el('div',null,''));
  var inp=document.createElement('input'); inp.id='spNew'; inp.type='text'; inp.placeholder='ex: NRD';
  var btn=document.createElement('button'); btn.id='spAdd'; btn.textContent='Ajouter spécialité';
  var col2=el('div',null,''); col2.appendChild(inp); var col3=el('div',null,''); col3.appendChild(btn);
  add.appendChild(col2); add.appendChild(col3);
  box.appendChild(add); box.appendChild(el('div',{class:'sep'},''));
  var list=el('div'); list.id='spList'; box.appendChild(list);
  host.appendChild(box);
  function draw(){
    clear(list);
    for(var i=0;i<data.specialties.length;i++){
      (function(idx){
        var row=el('div',null,data.specialties[idx]+' ');
        var dot=el('span'); dot.style.display='inline-block'; dot.style.width='10px'; dot.style.height='10px'; dot.style.borderRadius='50%'; dot.style.margin='0 6px'; dot.style.border='1px solid rgba(255,255,255,.6)'; dot.style.background=specColor(data.specialties[idx]);
        row.insertBefore(dot,row.firstChild);
        var ren=el('button',{class:'ghost'},'Renommer');
        ren.onclick=function(){
          var nv=prompt('Nouveau nom pour la spécialité', data.specialties[idx]);
          if(!nv) return; nv=nv.trim();
          if(!nv || nv===data.specialties[idx]) return;
          if(data.specialties.some(function(x){return (x||'').toLowerCase()===nv.toLowerCase();})){
            alert('Cette spécialité existe déjà.');
            return;
          }
          renameSpecialty(data.specialties[idx], nv); save(); draw();
        };
        var del=el('button',{class:'ghost'},'Supprimer'); del.onclick=function(){ if(!confirm('Supprimer '+data.specialties[idx]+' ?')) return; data.specialties.splice(idx,1); save(); draw(); };

        // Flags UI (Téléradiologie / CINAPS) per specialty
        (function(){
          var specName = data.specialties[idx];
          var f = (data.specFlags && data.specFlags[specName]) || {tele:false, cinaps:false};

          var lbT = document.createElement('label'); lbT.style.marginLeft='8px';
          var ckT = document.createElement('input'); ckT.type='checkbox'; ckT.checked=!!f.tele;
          ckT.onchange=function(){ setSpecFlag(specName, 'tele', this.checked); };
          lbT.appendChild(ckT); lbT.appendChild(document.createTextNode(' Téléradiologie'));
          row.appendChild(lbT);

          var lbC = document.createElement('label'); lbC.style.marginLeft='8px';
          var ckC = document.createElement('input'); ckC.type='checkbox'; ckC.checked=!!f.cinaps;
          ckC.onchange=function(){ setSpecFlag(specName, 'cinaps', this.checked); };
          lbC.appendChild(ckC); lbC.appendChild(document.createTextNode(' CINAPS'));
          row.appendChild(lbC);
        })();

        row.appendChild(ren); row.appendChild(document.createTextNode(' ')); row.appendChild(del);
        list.appendChild(row);
      })(i);
    }
  }
  btn.onclick=function(){ var v=inp.value.replace(/^\s+|\s+$/g,''); if(!v) return; if(data.specialties.some(function(x){return (x||'').toLowerCase()===v.toLowerCase();})) return; data.specialties.push(v); inp.value=''; save(); draw(); };
  draw();
}

function renderPracs(){
  var host=$('data-prats'); clear(host);
  var wrap=el('div',{class:'card-b'}); host.appendChild(wrap);
  var prList=el('div'); prList.id='prList'; wrap.appendChild(prList);
  function draw(){
    clear(prList);
    for(var i=0;i<data.practitioners.length;i++){
      (function(idx){
        var p=data.practitioners[idx]; var card=el('div',{class:'card'}); card.appendChild(el('div',{class:'card-h'}, p.name));
        var b=el('div',{class:'card-b'});
        var ck=document.createElement('input'); ck.type='checkbox'; ck.checked=p.cinaps; ck.onchange=function(){ p.cinaps=ck.checked; save(); };
        var lab=document.createElement('label'); lab.appendChild(ck); lab.appendChild(document.createTextNode(' CINAPS'));
        b.appendChild(lab); b.appendChild(document.createElement('div'));
        b.appendChild(el('div',null,'Spécialités :'));
        for(var s=0;s<data.specialties.length;s++){
          (function(S){
            var lb=document.createElement('label');
            var c=document.createElement('input'); c.type='checkbox'; c.checked=(p.specs||[]).indexOf(S)>=0;
            c.onchange=function(){
              var pos=(p.specs||[]).indexOf(S);
              if(c.checked){ if(pos<0){ (p.specs=p.specs||[]).push(S);} }
              else { if(pos>=0){ p.specs.splice(pos,1);} }
              save();
            };
            lb.appendChild(c); lb.appendChild(document.createTextNode(' '+S));
            b.appendChild(lb);
          })(data.specialties[s]);
        }
        var ren=el('button',{class:'ghost'},'Renommer');
        ren.onclick=function(){
          var oldName=p.name;
          var nv=prompt('Nouveau nom pour le praticien', oldName);
          if(!nv) return; nv=nv.trim();
          if(!nv || nv===oldName) return;
          if(data.practitioners.some(function(x){return (x.name||'').toLowerCase()===nv.toLowerCase();})){
            alert('Ce nom existe déjà.');
            return;
          }
          renamePractitioner(oldName, nv); save(); draw();
        };
        var del=el('button',{class:'ghost'},'Supprimer'); del.onclick=function(){ if(!confirm('Supprimer '+p.name+' ?')) return; data.practitioners.splice(idx,1); save(); draw(); };
        b.appendChild(document.createElement('div')); b.appendChild(ren); b.appendChild(document.createTextNode(' ')); b.appendChild(del);
        card.appendChild(b); prList.appendChild(card);
      })(i);
    }
  }
  var addRow=el('div',{class:'card-b'});
  var inp=document.createElement('input'); inp.id='prNew'; inp.type='text'; inp.placeholder='Nom (ex: MCEA)';
  var btn=document.createElement('button'); btn.id='prAdd'; btn.textContent='Ajouter';
  addRow.appendChild(inp); addRow.appendChild(document.createTextNode(' ')); addRow.appendChild(btn);
  host.appendChild(addRow);
  btn.onclick=function(){ var v=inp.value.replace(/^\s+|\s+$/g,''); if(!v) return; if(data.practitioners.some(function(x){return (x.name||'').toLowerCase()===v.toLowerCase();})) return; data.practitioners.push({name:v,specs:[],cinaps:false}); inp.value=''; save(); draw(); };
  draw();
}

function renderInterns(){
  var host=$('data-interns'); clear(host);
  var wrap=el('div',{class:'card-b'}); host.appendChild(wrap);
  var intList=el('div'); intList.id='intList'; wrap.appendChild(intList);
  function draw(){
    clear(intList);
    for(var i=0;i<data.interns.length;i++){
      (function(idx){
        var p=data.interns[idx]; var card=el('div',{class:'card'}); card.appendChild(el('div',{class:'card-h'}, p.name));
        var b=el('div',{class:'card-b'});
        b.appendChild(el('div',null,'Spécialités :'));
        for(var s=0;s<data.specialties.length;s++){
          (function(S){
            var lb=document.createElement('label');
            var c=document.createElement('input'); c.type='checkbox'; c.checked=(p.specs||[]).indexOf(S)>=0;
            c.onchange=function(){
              var pos=(p.specs||[]).indexOf(S);
              if(c.checked){ if(pos<0){ (p.specs=p.specs||[]).push(S);} }
              else { if(pos>=0){ p.specs.splice(pos,1);} }
              save();
            };
            lb.appendChild(c); lb.appendChild(document.createTextNode(' '+S));
            b.appendChild(lb);
          })(data.specialties[s]);
        }
        var ren=el('button',{class:'ghost'},'Renommer');
        ren.onclick=function(){
          var oldName=p.name;
          var nv=prompt('Nouveau nom pour l\'interne', oldName);
          if(!nv) return; nv=nv.trim();
          if(!nv || nv===oldName) return;
          if(data.interns.some(function(x){return (x.name||'').toLowerCase()===nv.toLowerCase();})){
            alert('Ce nom existe déjà.');
            return;
          }
          renameIntern(oldName, nv); save(); draw();
        };
        var del=el('button',{class:'ghost'},'Supprimer'); del.onclick=function(){ if(!confirm('Supprimer '+p.name+' ?')) return; data.interns.splice(idx,1); save(); draw(); };
        b.appendChild(document.createElement('div')); b.appendChild(ren); b.appendChild(document.createTextNode(' ')); b.appendChild(del);
        card.appendChild(b); intList.appendChild(card);
      })(i);
    }
  }
  var addRow=el('div',{class:'card-b'});
  var inp=document.createElement('input'); inp.id='intNew'; inp.type='text'; inp.placeholder='Nom (ex: Dupont I.)';
  var btn=document.createElement('button'); btn.id='intAdd'; btn.textContent='Ajouter';
  addRow.appendChild(inp); addRow.appendChild(document.createTextNode(' ')); addRow.appendChild(btn);
  host.appendChild(addRow);
  btn.onclick=function(){ var v=inp.value.replace(/^\s+|\s+$/g,''); if(!v) return; if(data.interns.some(function(x){return (x.name||'').toLowerCase()===v.toLowerCase();})) return; data.interns.push({name:v,specs:[]}); inp.value=''; save(); draw(); };
  draw();
}

function renderRooms(){
  var host=$('data-rooms'); clear(host);
  var wrap=el('div',{class:'card-b'}); host.appendChild(wrap);
  var rmList=el('div'); rmList.id='rmList'; wrap.appendChild(rmList);
  function draw(){
    clear(rmList);
    for(var i=0;i<data.rooms.length;i++){
      (function(idx){
        var r=data.rooms[idx]; var card=el('div',{class:'card'}); card.appendChild(el('div',{class:'card-h'}, r.name));
        var b=el('div',{class:'card-b'});
        b.appendChild(el('div',null,'Spécialités autorisées :'));
        for(var s=0;s<data.specialties.length;s++){
          (function(S){
            var lb=document.createElement('label');
            var c=document.createElement('input'); c.type='checkbox'; c.checked=(r.allow||[]).indexOf(S)>=0;
            c.onchange=function(){
              var pos=(r.allow||[]).indexOf(S);
              if(c.checked){ if(pos<0){ (r.allow=r.allow||[]).push(S);} }
              else { if(pos>=0){ r.allow.splice(pos,1);} }
              save();
            };
            lb.appendChild(c);
            var dot=el('span'); dot.style.display='inline-block'; dot.style.width='10px'; dot.style.height='10px'; dot.style.borderRadius='50%'; dot.style.margin='0 6px'; dot.style.border='1px solid rgba(255,255,255,.6)'; dot.style.background=specColor(S);
            lb.appendChild(dot); lb.appendChild(document.createTextNode(' '+S));
            b.appendChild(lb);
          })(data.specialties[s]);
        }

// Options de remplacement par salle
b.appendChild(document.createElement('div'));
var lbT=document.createElement('label'); var ckT=document.createElement('input'); ckT.type='checkbox'; ckT.checked=!!r.allowTele;
ckT.onchange=function(){ r.allowTele=!!this.checked; save(); };
lbT.appendChild(ckT); lbT.appendChild(document.createTextNode(' Remplaçable par Téléradiologie'));
b.appendChild(lbT);

var lbC=document.createElement('label'); var ckC=document.createElement('input'); ckC.type='checkbox'; ckC.checked=!!r.allowCinaps;
ckC.onchange=function(){ r.allowCinaps=!!this.checked; save(); };
lbC.appendChild(ckC); lbC.appendChild(document.createTextNode(' Remplaçable par CINAPS (NRD)'));
b.appendChild(lbC);

var ren=el('button',{class:'ghost'},'Renommer');
ren.onclick=function(){
  var oldName=r.name;
  var nv=prompt('Nouveau nom pour la salle', oldName);
  if(!nv) return; nv=nv.trim();
  if(!nv || nv===oldName) return;
  if(data.rooms.some(function(x){return (x.name||'').toLowerCase()===nv.toLowerCase();})){
    alert('Ce nom existe déjà.');
    return;
  }
  renameRoom(oldName, nv); save(); draw();
};
var del=el('button',{class:'ghost'},'Supprimer');
del.onclick=function(){ if(!confirm('Supprimer '+r.name+' ?')) return; data.rooms.splice(idx,1); save(); draw(); };
b.appendChild(document.createElement('div')); b.appendChild(ren); b.appendChild(document.createTextNode(' ')); b.appendChild(del);
card.appendChild(b); rmList.appendChild(card);
// … fin du contexte existant …

/* ====== Stats ====== */
function renderStats(){
  var w=$('stWeek'); ensureWeek(parseInt(w.value,10));
  var cont=$('stTable'); clear(cont);
  var tbl=document.createElement('table'); tbl.setAttribute('data-name','Stats Praticiens S'+pad2(parseInt(w.value,10)));
  var thead=document.createElement('thead'); var trh=document.createElement('tr'); ['Praticien','Lun','Mar','Mer','Jeu','Ven','Total'].forEach(function(h){ trh.appendChild(el('th',null,h)); }); thead.appendChild(trh); tbl.appendChild(thead);
  var tb=document.createElement('tbody');
  for(var i=0;i<data.practitioners.length;i++){
    var p=data.practitioners[i]; var tr=document.createElement('tr'); tr.appendChild(el('td',null,p.name)); var tot=0;
    for(var d=0; d<5; d++){
      var cnt=0;
      for(var ri=0; ri<data.rooms.length; ri++){
        for(var s=0; s<SLOTS.length; s++){
          var a=getAssignment(parseInt(w.value,10),ri,d,s);
          if((a.repPrac||a.prac)===p.name){
            if(isRestAfterGuard(parseInt(w.value,10),d,(a.repPrac||a.prac))) continue;
            if(data.absences[String(w.value)][DAYS[d]][(a.repPrac||a.prac)]) continue;
            cnt++;
          }
        }
      }
      tr.appendChild(el('td',null,String(cnt))); tot+=cnt;
    }
    tr.appendChild(el('td',null,String(tot))); tb.appendChild(tr);
  }
  tbl.appendChild(tb); cont.appendChild(tbl);
  $('btnExportStP').onclick=function(){ exportTableCSV(tbl,'Stats_Praticiens_S'+pad2(parseInt(w.value,10))+'.csv'); };
  w.onchange=function(){ ensureWeek(parseInt(w.value,10)); renderStats(); };
}
function renderStatsIntern(){
  var w=$('stIWeek'); ensureWeek(parseInt(w.value,10));
  var cont=$('stITable'); clear(cont);
  var tbl=document.createElement('table'); tbl.setAttribute('data-name','Stats Internes S'+pad2(parseInt(w.value,10)));
  var thead=document.createElement('thead'); var trh=document.createElement('tr'); ['Interne','Lun','Mar','Mer','Jeu','Ven','Total'].forEach(function(h){ trh.appendChild(el('th',null,h)); }); thead.appendChild(trh); tbl.appendChild(thead);
  var tb=document.createElement('tbody');
  for(var i=0;i<data.interns.length;i++){
    var p=data.interns[i]; var tr=document.createElement('tr'); tr.appendChild(el('td',null,p.name)); var tot=0;
    for(var d=0; d<5; d++){
      var cnt=0;
      for(var ri=0; ri<data.rooms.length; ri++){
        for(var s=0; s<SLOTS.length; s++){
          var a=getAssignment(parseInt(w.value,10),ri,d,s);
          if((a.repIntern||a.intern)===p.name){
            if(isRestAfterGuardIntern(parseInt(w.value,10),d,(a.repIntern||a.intern))) continue;
            if(data.absencesIntern[String(w.value)][DAYS[d]][(a.repIntern||a.intern)]) continue;
            cnt++;
          }
        }
      }
      tr.appendChild(el('td',null,String(cnt))); tot+=cnt;
    }
    tr.appendChild(el('td',null,String(tot))); tb.appendChild(tr);
  }
  tbl.appendChild(tb); cont.appendChild(tbl);
  $('btnExportStI').onclick=function(){ exportTableCSV(tbl,'Stats_Internes_S'+pad2(parseInt(w.value,10))+'.csv'); };
  w.onchange=function(){ ensureWeek(parseInt(w.value,10)); renderStatsIntern(); };
}

function initStatsAdvanced(){
  var ySel=$('stAdvYear'); buildYearSelect(ySel, 2025);
  $('stAdvMonth').value='7';
  function updateMode(){
    var mode=$('stMode').value;
    $('ctlWeek').className = 'item'+(mode==='week'?'':' hidden');
    $('ctlDay').className = 'item'+(mode==='day'?'':' hidden');
    $('ctlMonth').className = 'item'+(mode==='month'?'':' hidden');
  }
  $('stMode').onchange=updateMode; updateMode();
  $('stRefresh').onclick=function(){ renderStatsAdvanced(); };
  $('btnExportStAdv').onclick=function(){
    var t=$('stAdvOut').querySelector('table'); if(t) exportTableCSV(t,'Stats_Avancees.csv');
  };
  renderStatsAdvanced();
}
function renderStatsAdvanced(){
  var out=$('stAdvOut'); clear(out);
  var mode=$('stMode').value, group=$('stGroup').value;

  function addRow(tb, cells){ var tr=document.createElement('tr'); for(var i=0;i<cells.length;i++) tr.appendChild(el('td',null,String(cells[i]))); tb.appendChild(tr); }
  function addHeader(tbl, cells){ var thead=document.createElement('thead'); var trh=document.createElement('tr'); for(var i=0;i<cells.length;i++) trh.appendChild(el('th',null,String(cells[i]))); thead.appendChild(trh); tbl.appendChild(thead); }
  function countToHours(cnt){ return cnt+' h'; }

  function aggregateSlotsWeek(week){
    var rows=[];
    for(var ri=0; ri<data.rooms.length; ri++){
      for(var d=0; d<5; d++){
        for(var s=0; s<SLOTS.length; s++){
          var a=getAssignment(week,ri,d,s);
          if(!a.spec && !a.prac && !a.intern) continue;
          rows.push({room:data.rooms[ri].name, dayIdx:d, slotIdx:s, spec:a.spec, prac:(a.repPrac||a.prac), intern:(a.repIntern||a.intern)});
        }
      }
    }
    return rows;
  }

  if(mode==='week' || mode==='day'){
    var week=parseInt($('stAdvWeek').value,10)||1; ensureWeek(week);
    var rows=aggregateSlotsWeek(week);
    if(mode==='day'){ var dsel=parseInt($('stAdvDay').value,10)||0; rows=rows.filter(function(r){ return r.dayIdx===dsel; }); }

    var map={}, mapRooms={}, roomsSet={};
    function bump(key, room){ map[key]=(map[key]||0)+1; roomsSet[room]=true; if(!mapRooms[key]) mapRooms[key]={}; mapRooms[key][room]=(mapRooms[key][room]||0)+1; }

    for(var i=0;i<rows.length;i++){
      var r=rows[i];
      if(group==='prac'){
        if(!r.prac) continue;
        if(isRestAfterGuard(week, r.dayIdx, r.prac)) continue;
        if(data.absences[String(week)] && data.absences[String(week)][DAYS[r.dayIdx]] && data.absences[String(week)][DAYS[r.dayIdx]][r.prac]) continue;
        bump(r.prac, r.room);
      } else {
        if(!r.spec) continue;
        bump(r.spec, r.room);
      }
    }

    var roomList=data.rooms.map(function(r){return r.name;});
    var cols = ['Groupe'].concat(roomList).concat(['Total']);
    var tbl=document.createElement('table'); addHeader(tbl, cols);
    var tb=document.createElement('tbody');
    var keys=Object.keys(map).sort();
    for(var i=0;i<keys.length;i++){
      var k=keys[i]; var total=0, row=[k];
      for(var j=0;j<roomList.length;j++){ var v=(mapRooms[k][roomList[j]]||0); row.push(countToHours(v)); total+=v; }
      row.push(countToHours(total)); addRow(tb,row);
    }
    tbl.appendChild(tb); var wrap=document.createElement('div'); wrap.className='table'; wrap.appendChild(tbl); out.appendChild(wrap);
  }

  if(mode==='month'){
    var month=parseInt($('stAdvMonth').value,10)||0;
    var year=parseInt($('stAdvYear').value,10)||2025;

    // Build rows by iterating real dates to capture overrides (repPrac/repIntern)
    var rows=[];
    var d=new Date(year, month, 1);
    while(d.getMonth()===month){
      var wd=(d.getDay()+6)%7; // 0=Mon..6=Sun
      if(wd<5){
        var wk = isoWeekNumber(d);
        ensureWeek(wk);
        for(var ri=0; ri<data.rooms.length; ri++){
          for(var s=0; s<SLOTS.length; s++){
            var a=getAssignment(wk,ri,wd,s);
            if(!a.spec && !a.prac && !a.intern) continue;
            rows.push({
              room: data.rooms[ri].name,
              dayIdx: wd,
              week: wk,
              spec: a.spec,
              prac: (a.repPrac||a.prac),
              intern: (a.repIntern||a.intern)
            });
          }
        }
      }
      d.setDate(d.getDate()+1);
    }

    // Aggregate
    var map={}, mapRooms={};
    function bump(key, room, val){
      map[key]=(map[key]||0)+val;
      if(!mapRooms[key]) mapRooms[key]={};
      mapRooms[key][room]=(mapRooms[key][room]||0)+val;
    }

    for(var i2=0;i2<rows.length;i2++){
      var r=rows[i2];
      if(group==='prac'){
        if(!r.prac) continue;
        if(isRestAfterGuard(r.week, r.dayIdx, r.prac)) continue;
        if(data.absences[String(r.week)] && data.absences[String(r.week)][DAYS[r.dayIdx]] && data.absences[String(r.week)][DAYS[r.dayIdx]][r.prac]) continue;
        bump(r.prac, r.room, 1);
      } else {
        if(!r.spec) continue;
        bump(r.spec, r.room, 1);
      }
    }

    var roomList=data.rooms.map(function(r){return r.name;});
    var cols=['Groupe'].concat(roomList).concat(['Total']);
    var tbl=document.createElement('table'); addHeader(tbl, cols); var tb=document.createElement('tbody');
    var keys=Object.keys(map).sort();
    for(var k=0;k<keys.length;k++){
      var key=keys[k]; var total=0, row=[key];
      for(var j2=0;j2<roomList.length;j2++){ var v=(mapRooms[key][roomList[j2]]||0); row.push(countToHours(v)); total+=v; }
      row.push(countToHours(total)); addRow(tb,row);
    }
    tbl.appendChild(tb); var wrap=document.createElement('div'); wrap.className='table'; wrap.appendChild(tbl); out.appendChild(wrap);
  }
}

/* ====== Astreintes (RI / NRI) ====== */
function practitionerNamesBySpec(spec){
  try{
    var names = (data.practitioners||[]).filter(function(p){ return (p.specs||[]).indexOf(spec)>=0; }).map(function(p){ return p.name; });
    if(!names.length){ names = (data.practitioners||[]).map(function(p){ return p.name; }); }
    return names;
  }catch(e){ return (data.practitioners||[]).map(function(p){ return p.name; }); }
}
function buildOncallTable(containerId, yearSelId, weekInputId, specKey, rangeSpanId, exportBtnId){
  buildYearSelect($(yearSelId), 2025);
  var y = parseInt($(yearSelId).value,10);
  var w = $(weekInputId);
  ensureWeek(parseInt(w.value,10));
  var dates = weekDates(y, parseInt(w.value,10));
  $(rangeSpanId).textContent = 'S'+pad2(parseInt(w.value,10))+' · '+fmtDate(dates[0])+' → '+fmtDate(dates[6])+' / '+y;

  var cont = $(containerId); clear(cont);
  var tbl = document.createElement('table'); tbl.setAttribute('data-name','Astreinte '+specKey+' S'+pad2(parseInt(w.value,10)));
  var thead = document.createElement('thead');
  var trh = document.createElement('tr'); trh.appendChild(el('th',null,'Jour')); trh.appendChild(el('th',null,'Praticien d\'astreinte')); thead.appendChild(trh); tbl.appendChild(thead);
  var tb = document.createElement('tbody');

  var names = practitionerNamesBySpec(specKey);
  for(var i=0;i<GUARD_DAYS.length;i++){
    (function(day, idx){
      var tr=document.createElement('tr'); tr.appendChild(el('td',null,day+' '+fmtDate(dates[idx])));
      var td=document.createElement('td'); var sel=document.createElement('select');
      var opt=document.createElement('option'); opt.value=''; opt.text='—'; sel.appendChild(opt);
      for(var p=0;p<names.length;p++){ var o=document.createElement('option'); o.value=names[p]; o.text=names[p]; sel.appendChild(o); }
      var W = String(w.value);
      var cur = (data.oncalls && data.oncalls[W] && data.oncalls[W][specKey] && data.oncalls[W][specKey][day]) || '';
      sel.value = cur;
      sel.onchange=function(){
        try{
          if(!data.oncalls) data.oncalls = {};
          if(!data.oncalls[W]) data.oncalls[W] = {RI:{}, NRI:{}};
          if(!data.oncalls[W][specKey]) data.oncalls[W][specKey] = {};
          data.oncalls[W][specKey][day] = this.value;
          save();
        }catch(e){}
      };
      td.appendChild(sel); // (corrigé) — plus de double append
      var ocAlert=document.createElement('span'); ocAlert.className='tag err'; ocAlert.style.marginLeft='8px'; ocAlert.textContent='ABSENT ce jour';
      ocAlert.style.display = isAbsentOnGuardDay(String(w.value), day, sel.value, false) ? '' : 'none';
      td.appendChild(ocAlert);
      sel.addEventListener('change', function(){
        ocAlert.style.display = isAbsentOnGuardDay(String(w.value), day, sel.value, false) ? '' : 'none';
      });
      tr.appendChild(td); tb.appendChild(tr);
    })(GUARD_DAYS[i], i);
  }
  tbl.appendChild(tb);
  var wrap = document.createElement('div'); wrap.className='table'; wrap.appendChild(tbl); $(containerId).appendChild(wrap);

  // Export
  $(exportBtnId).onclick = function(){ exportTableCSV(tbl, 'Astreinte_'+specKey+'_S'+pad2(parseInt(w.value,10))+'.csv'); };
  // Reactivity
  $(yearSelId).onchange = function(){ setWeekYear(parseInt($(weekInputId).value,10), parseInt($(yearSelId).value,10)); buildOncallTable(containerId, yearSelId, weekInputId, specKey, rangeSpanId, exportBtnId); };
  w.onchange = function(){ ensureWeek(parseInt(w.value,10)); setWeekYear(parseInt(w.value,10), parseInt($(yearSelId).value,10)); buildOncallTable(containerId, yearSelId, weekInputId, specKey, rangeSpanId, exportBtnId); };
}
function renderOncalls(){
  buildOncallTable('ocTableNRI','ocYear','ocWeek','NRI','ocRangeNRI','btnExportOcNRI');
  // RI uses the SAME week/year selectors as NRI to keep them in sync:
  buildOncallTable('ocTableRI','ocYear','ocWeek','RI','ocRangeRI','btnExportOcRI');
}

/* ====== Normalisation des données (ajouté) ====== */
function normalizeData(){
  try{
    (data.rooms||[]).forEach(function(r){
      if (typeof r.allowTele   === 'undefined') r.allowTele = true;
      if (typeof r.allowCinaps === 'undefined') r.allowCinaps = false;
      if (!Array.isArray(r.allow)) r.allow = [];
    });
  }catch(e){}
}

/* ====== Save / Import ====== */
function buildSave(){
  $('btnExport').onclick=function(){
    var blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
    var a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='Neptune_backup.json'; a.click(); URL.revokeObjectURL(a.href);
  };
  $('btnImport').onclick=async function(){
    var f=$('fileImport').files[0]; if(!f) return;
    var r=new FileReader();
    r.onload=async function(){
      try{
        var j=JSON.parse(String(r.result||'{}'));
        data=j; normalizeData(); save(); // (corrigé) normalisation après import
        if(window.__neptuneAutosave && typeof saveHtmlToDisk==='function'){
          try{ await saveHtmlToDisk(); }catch(_){}
          alert('Import OK — enregistré dans le fichier.');
        }else if('showOpenFilePicker' in window){
          if(confirm('Import OK. Voulez-vous l\'enregistrer dans ce fichier HTML ?')){
            try{ await pickHtmlFile(); }catch(_){}
          } else {
            alert('Import OK (non enregistré dans le fichier).');
          }
        }else{
          alert('Import OK (pas d\'accès disque ; données conservées en mémoire/localStorage).');
        }
        location.reload();
      }catch(e){ alert('Import invalide'); }
    };
    r.readAsText(f);
  };
  $('btnReset').onclick=function(){ if(!confirm('Tout réinitialiser ?')) return; localStorage.removeItem(KEY); location.reload(); };
}

/* ====== Boot + Global Week/Year State ====== */
// Persist selected week/year across tabs & sessions
var UIKEY = 'neptune-ui';
function defaultUI(){
  try{
    var now = new Date();
    return {year: now.getFullYear(), week: isoWeekNumber(now)};
  }catch(e){ return {year: 2025, week: 36}; }
}
var ui = (function(){
  try{
    var s = localStorage.getItem(UIKEY);
    if(s){
      var o = JSON.parse(s);
      if(o && o.year && o.week) return {year: parseInt(o.year,10), week: parseInt(o.week,10)};
    }
  }catch(e){}
  return defaultUI();
})();
function saveUI(){ try{ localStorage.setItem(UIKEY, JSON.stringify(ui)); }catch(e){} }
function updateBadge(){ try{ $('wkBadge').textContent = 'S'+pad2(ui.week)+' · '+ui.year; }catch(e){} }
function setWeekYear(w, y){
  try{
    if(typeof w!=='undefined' && w!==null) ui.week = Math.max(1, Math.min(53, parseInt(w,10)||ui.week));
    if(typeof y!=='undefined' && y!==null) ui.year = parseInt(y,10)||ui.year;
    saveUI();
    updateBadge();
  }catch(e){}
}
function syncWeekControls(){
  try{
    var years = ['accYear','absrepYear','absYear','absIYear','gdYear','gdIYear','ocYear','stYear','stIYear','stAdvYear', 'ppYear'];
    var weeks = ['accWeek','absrepWeek','absWeek','absIWeek','gdWeek','gdIWeek','ocWeek','stWeek','stIWeek','stAdvWeek', 'ppWeek'];
    for(var i=0;i<years.length;i++){ var a=$(years[i]); if(a) a.value = String(ui.year); }
    for(var j=0;j<weeks.length;j++){ var b=$(weeks[j]); if(b) b.value = String(ui.week); }
  }catch(e){}
}
function hookBadgeEditor(){
  try{
    var b = $('wkBadge'); if(!b) return;
    b.style.cursor = 'pointer';
    b.title = 'Cliquer pour modifier la semaine/année globale';
    b.onclick = function(){
      var cur = 'S'+pad2(ui.week)+' · '+ui.year;
      var txt = prompt("Semaine ISO et année (ex: 'S36 · 2025' ou '36 2025')", cur);
      if(!txt) return;
      var wm = txt.match(/S?\s*(\d{1,2})/i);
      var ym = txt.match(/(19\d{2}|20\d{2})/);
      var nw = wm ? parseInt(wm[1],10) : ui.week;
      var ny = ym ? parseInt(ym[1],10) : ui.year;
      setWeekYear(nw, ny);
      try{ syncWeekControls(); if(window.refreshActivePage) refreshActivePage(); else renderAccueil(); }catch(e){}
    };
  }catch(e){}
}

// Lancement
normalizeData(); // (ajouté) normaliser les données existantes
buildTabs();
// Initialize UI from persisted state
syncWeekControls();
updateBadge();
hookBadgeEditor();
})();
</script>

<!-- ⚠️ Place ici, juste après, UN SEUL bloc de données : -->
<!-- <script type="application/json" id="NEPTUNE_EMBED"> …votre JSON unique… </script> -->


</body></html>
