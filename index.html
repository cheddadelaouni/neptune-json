<html lang="fr"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>NEPTUNE · Planning Radiologie</title>
<style>
:root{
  --bg:#0d1117;
  --panel:#0f172a;
  --card:#111827;
  --muted:#1f2937;
  --line:#253044;
  --text:#e5e7eb;
  --sub:#9ca3af;
  --acc:#60a5fa;
  --acc2:#f59e0b;
  --ok:#16a34a;
  --warn:#f59e0b;
  --err:#ef4444;
}
*{box-sizing:border-box}
html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif}
body{overflow-y:scroll}
a{color:inherit;text-decoration:none}a:hover{text-decoration:underline}
button{cursor:pointer}

/* Layout */
.header{position:sticky;top:0;z-index:50;background:linear-gradient(180deg,#0d1117,#0d111700);backdrop-filter:saturate(120%) blur(6px);padding:10px 12px;border-bottom:1px solid var(--line)}
.header .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.brand{font-weight:700;letter-spacing:.3px}
.badge{display:inline-flex;align-items:center;gap:6px;padding:2px 8px;border:1px solid var(--line);border-radius:999px;color:var(--sub)}
.sp{flex:1}

.tabs{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px}
.tab{padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:#0b1220;color:#cbd5e1}
.tab[aria-selected="true"], .tab:hover{background:linear-gradient(180deg,#0f172a,#0b1220);border-color:#2b3a56;color:#fff}

main{max-width:1200px;margin:14px auto;padding:0 12px}
section[hidden]{display:none!important}
.card{background:linear-gradient(180deg,#0f172a,#0c1323);border:1px solid var(--line);border-radius:14px;box-shadow:0 4px 20px #00000033}
.card h3{margin:0 0 8px 0}
.card .body{padding:14px}
hr.soft{border:0;border-top:1px dashed var(--line);margin:12px 0}

/* Tables */
.table{width:100%;border-collapse:collapse}
.table th,.table td{border:1px solid var(--line);padding:6px 8px;vertical-align:top}
.table th{background:#0b1220;color:#cbd5e1}
.table caption{caption-side:bottom;color:var(--sub);padding:6px}

/* Controls */
.input,select,button{background:#0b1220;border:1px solid var(--line);color:#e5e7eb;border-radius:10px;padding:6px 8px}
.btn{padding:6px 10px}
.btn.acc{border-color:#3b82f6}
.btn.ok{border-color:#16a34a}
.btn.warn{border-color:#f59e0b}
.btn.err{border-color:#ef4444}
.grid{display:grid;gap:10px}
.grid.cols-2{grid-template-columns:1fr 1fr}
.grid.cols-3{grid-template-columns:repeat(3,1fr)}
.grid.cols-4{grid-template-columns:repeat(4,1fr)}

/* Calendar blocks */
.kal{display:grid;grid-template-columns:repeat(7,1fr);gap:8px}
.kal .day{border:1px solid var(--line);border-radius:12px;padding:8px;min-height:110px}
.kal .head{display:flex;justify-content:space-between;color:var(--sub);margin-bottom:6px}
.tag{display:inline-flex;align-items:center;gap:6px;padding:2px 8px;border:1px solid var(--line);border-radius:999px}
.tag.ok{border-color:#16a34a}
.tag.err{border-color:#ef4444}
.tag.warn{border-color:#f59e0b}

/* Sticky save footer */
.savebar{position:sticky;bottom:0;background:linear-gradient(0deg,#0d1117,#0d111700);backdrop-filter:saturate(120%) blur(6px);border-top:1px solid var(--line);padding:10px 12px;display:flex;gap:8px;align-items:center;z-index:40}

/* Small helpers */
.small{color:#9ca3af;font-size:12px}
.muted{color:#9ca3af}
.h{display:none}

</style>
</head>
<body>
  <header class="header">
    <div class="row">
      <div class="brand">NEPTUNE</div>
      <div class="badge" id="roleBox">Rôle: <b id="who"></b></div>
      <div class="badge" id="weekBadge">S<span id="curWeek">--</span> · <span id="curYear">----</span></div>
      <div class="sp"></div>
      <button class="btn" id="prevW">⟵ Semaine -1</button>
      <button class="btn" id="nextW">Semaine +1 ⟶</button>
      <button class="btn" id="btnPullNow">Charger central</button>
      <button class="btn" id="btnPushNow">Sauver central</button>
      <button class="btn" id="logout">Se déconnecter</button>
    </div>
    <nav class="tabs" id="tabs"></nav>
  </header>

  <main>
    <section id="page-acc" hidden>
      <div class="card"><div class="body">
        <h3>Accueil</h3>
        <p class="muted">Bienvenue dans l’outil NEPTUNE. Choisissez un onglet pour commencer.</p>
      </div></div>
    </section>

    <section id="page-cal" hidden>
      <div class="card"><div class="body">
        <h3>Calendrier</h3>
        <div class="grid cols-4">
          <label>Mois
            <select id="selMonth"></select>
          </label>
          <label>Année
            <input type="number" id="selYear" class="input" min="2020" max="2100">
          </label>
          <div></div>
          <button class="btn" id="btnGoCal">Aller</button>
        </div>
        <hr class="soft">
        <div class="kal" id="kal"></div>
      </div></div>
    </section>

    <section id="page-prac" hidden>
      <div class="card"><div class="body">
        <h3>Planning praticien</h3>
        <div class="grid cols-3">
          <label>Praticien <select id="selPrac"></select></label>
          <label>Semaine <input type="number" id="selWPrac" class="input" min="1" max="53"></label>
          <label>Année <input type="number" id="selYPrac" class="input" min="2020" max="2100"></label>
        </div>
        <hr class="soft">
        <div id="pracView"></div>
      </div></div>
    </section>

    <section id="page-intern" hidden>
      <div class="card"><div class="body">
        <h3>Planning interne</h3>
        <div class="grid cols-3">
          <label>Interne <select id="selIntern"></select></label>
          <label>Semaine <input type="number" id="selWIntern" class="input" min="1" max="53"></label>
          <label>Année <input type="number" id="selYIntern" class="input" min="2020" max="2100"></label>
        </div>
        <hr class="soft">
        <div id="internView"></div>
      </div></div>
    </section>

    <section id="page-absrep" hidden>
      <div class="card"><div class="body">
        <h3>Absences & Remplacements</h3>
        <div id="absrepView"></div>
      </div></div>
    </section>

    <section id="page-week" hidden>
      <div class="card"><div class="body">
        <h3>Semaine type (par salles)</h3>
        <div class="grid cols-4">
          <label>Salle <select id="wkRoom"></select></label>
          <label>Jour <select id="wkDay"></select></label>
          <label>Spécialité <select id="wkSpec"></select></label>
          <label>Chef <select id="wkPrac"></select></label>
          <label>Interne <select id="wkIntern"></select></label>
          <label>Début <input type="time" id="wkStart" class="input"></label>
          <label>Fin <input type="time" id="wkEnd" class="input"></label>
          <div class="sp"></div>
          <button class="btn acc" id="wkApply">Appliquer</button>
          <button class="btn warn" id="wkClear">Vider</button>
        </div>
        <hr class="soft">
        <div id="wkView"></div>
      </div></div>
    </section>

    <section id="page-abs" hidden>
      <div class="card"><div class="body">
        <h3>Absences</h3>
        <div id="absView"></div>
      </div></div>
    </section>

    <section id="page-guard" hidden>
      <div class="card"><div class="body">
        <h3>Gardes</h3>
        <div id="guardView"></div>
      </div></div>
    </section>

    <section id="page-oncall" hidden>
      <div class="card"><div class="body">
        <h3>Astreintes</h3>
        <div id="oncallView"></div>
      </div></div>
    </section>

    <section id="page-data" hidden>
      <div class="card"><div class="body">
        <h3>Données</h3>
        <div class="grid cols-3">
          <div>
            <h4>Spécialités</h4>
            <div id="specView"></div>
          </div>
          <div>
            <h4>Praticiens</h4>
            <div id="pracList"></div>
          </div>
          <div>
            <h4>Internes</h4>
            <div id="internList"></div>
          </div>
        </div>
        <hr class="soft">
        <h4>Salles</h4>
        <div id="roomsView"></div>
      </div></div>
    </section>

    <section id="page-stats" hidden>
      <div class="card"><div class="body">
        <h3>Statistiques</h3>
        <div id="statsView"></div>
      </div></div>
    </section>

    <section id="page-save" hidden>
      <div class="card"><div class="body">
        <h3>Sauvegarde</h3>
        <div class="grid cols-2">
          <div>
            <h4>Export / Import JSON</h4>
            <div class="grid cols-2">
              <button class="btn acc" id="btnExport">Exporter JSON</button>
              <label class="btn"><input type="file" id="fileImport" class="h">Importer JSON</label>
            </div>
            <p class="small">Conseillé pour migrer les données d’une machine à l’autre.</p>
          </div>
          <div>
            <h4>Autosauvegarde dans le fichier</h4>
            <div class="grid cols-2">
              <button class="btn" id="btnPick">Choisir ce fichier pour l’autosauvegarde</button>
              <button class="btn ok" id="btnSaveHtml">Enregistrer maintenant</button>
            </div>
            <p class="small" id="pickHint">Si votre navigateur ne supporte pas, utilisez l’export JSON.</p>
          </div>
        </div>
        <hr class="soft">
        <h4>Sauvegarde centralisée (JsonStorage)</h4>
        <div class="grid cols-2">
          <button class="btn" id="pullCentral">← Recharger</button>
          <button class="btn ok" id="pushCentral">Pousser →</button>
        </div>
        <p class="small">Synchronise avec un JSON distant (URL fixe + API key).</p>
      </div></div>
    </section>
  </main>

  <!-- Données intégrées dans la page (écrites/relues pour l’autosauvegarde) -->
  <script id="NEPTUNE_EMBED" type="application/json">{
    "year": 2025,
    "week": 33,
    "specialties": ["Scanner", "IRM 1.5T", "IRM 3T", "Urgences", "NRI"],
    "specFlags": {"Scanner": {"tele": true, "cinaps": true}, "IRM 1.5T": {"tele": true, "cinaps": true}, "IRM 3T": {"tele": true, "cinaps": true}, "Urgences": {"tele": false, "cinaps": false}, "NRI": {"tele": false, "cinaps": true}},
    "practitioners": [{"name": "MCEA", "specs": ["IRM 3T", "NRI"], "cinaps": true},{"name": "JCG", "specs": ["Scanner", "IRM 1.5T"], "cinaps": false}],
    "interns": [{"name": "Théo"},{"name":"Lise"}],
    "rooms": [{"label": "IRM 3T", "allow": ["IRM 3T"], "allowTele": true, "allowCinaps": true, "schedule": [[],[],[],[],[],[],[]]}, {"label":"Scanner", "allow":["Scanner"], "allowTele": true, "allowCinaps": false, "schedule":[[],[],[],[],[],[],[]]}],
    "absences": [],
    "guards": [],
    "oncalls": []
  }</script>

  <script>
  // ====== Helpers UI ======
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  const el = (tag, attrs={}, ...kids) => { const n=document.createElement(tag); Object.entries(attrs).forEach(([k,v])=> (k==="class"? n.className=v : k==="html"? n.innerHTML=v : n.setAttribute(k,v))); kids.forEach(c=> n.appendChild(typeof c==="string"? document.createTextNode(c): c)); return n; };

  // ====== État global ======
  let data = JSON.parse(document.getElementById('NEPTUNE_EMBED').textContent);
  let ROLE = 'interne';

  // ====== Auth simplifiée ======
  function askAuth(){
    const id = prompt('Identifiant (admin, senior, interne)');
    if(!id) return;
    const code = prompt('Code');
    const low = (id||'').toLowerCase();
    if((low==='admin'   && code==='radiocb29!') ||
       (low==='senior'  && code==='radiocb29')  ||
       (low==='interne' && code==='radiocb')){
      ROLE = low;
      sessionStorage.setItem('role', ROLE);
      $('#who').textContent = ROLE;
      alert('Connecté en '+ROLE);
    } else {
      alert('Identifiant ou code invalide');
      askAuth();
    }
  }
  ROLE = sessionStorage.getItem('role') || 'interne';
  $('#who').textContent = ROLE;

  // ====== Droits ======
  function can(action){
    if(ROLE==='admin') return true;
    if(ROLE==='senior') return action !== 'admin-only';
    if(ROLE==='interne') return action === 'read' || action === 'self';
    return false;
  }

  // ====== Navigation / Onglets ======
  const PAGES = [
    {id:'page-acc',    title:'Accueil'},
    {id:'page-cal',    title:'Calendrier'},
    {id:'page-prac',   title:'Planning praticien'},
    {id:'page-intern', title:'Planning interne'},
    {id:'page-absrep', title:'Absences & Remplacements'},
    {id:'page-week',   title:'Semaine type'},
    {id:'page-abs',    title:'Absences'},
    {id:'page-guard',  title:'Gardes'},
    {id:'page-oncall', title:'Astreintes'},
    {id:'page-data',   title:'Données'},
    {id:'page-stats',  title:'Statistiques'},
    {id:'page-save',   title:'Sauvegarde'}
  ];
  const tabs = $('#tabs');
  PAGES.forEach((p,i)=>{
    const b = el('a', {href:'#'+p.id, class:'tab', role:'tab', 'aria-selected': i? 'false':'true'}, p.title);
    b.addEventListener('click', ev=>{ ev.preventDefault(); selectPage(p.id); });
    tabs.appendChild(b);
  });
  function selectPage(id){
    PAGES.forEach(p=>{
      const on = (p.id===id);
      $('#'+p.id).hidden = !on;
      const tab = Array.from(tabs.children).find(x=> x.getAttribute('href')==='#'+p.id);
      if(tab) tab.setAttribute('aria-selected', on? 'true':'false');
    });
    refreshActivePage();
  }
  selectPage('page-acc');

  // ====== Semaine/année courantes ======
  function isoWeekNumber(d){ d=new Date(Date.UTC(d.getFullYear(),d.getMonth(),d.getDate())); const dayNum=(d.getUTCDay()+6)%7; d.setUTCDate(d.getUTCDate()-dayNum+3); const jan4=new Date(Date.UTC(d.getUTCFullYear(),0,4)); const weekNo=1+Math.round(((d-jan4)/86400000-3+((jan4.getUTCDay()+6)%7))/7); return weekNo; }
  function isoWeekStartLocal(year,week){ const jan4=new Date(year,0,4); const day=(jan4.getDay()+6)%7; const monday=new Date(year,0,4-day+(week-1)*7); monday.setHours(0,0,0,0); return monday; }
  function weekRange(year,week){ const m=isoWeekStartLocal(year,week); const d=[...Array(7)].map((_,i)=> new Date(m.getFullYear(),m.getMonth(),m.getDate()+i)); return d; }

  function updateBadges(){ $('#curWeek').textContent=data.week; $('#curYear').textContent=data.year; }
  updateBadges();

  // ====== Rendu conditionnel ======
  function refreshActivePage(){
    const on = PAGES.find(p=> !$('#'+p.id).hidden);
    if(!on) return;
    if(on.id==='page-acc') renderAccueil();
    else if(on.id==='page-cal') renderCalendar();
    else if(on.id==='page-prac') renderPracPage();
    else if(on.id==='page-intern') renderInternPage();
    else if(on.id==='page-absrep') renderAbsRep();
    else if(on.id==='page-week') renderWeekPage();
    else if(on.id==='page-abs') renderAbsPage();
    else if(on.id==='page-guard') renderGuardPage();
    else if(on.id==='page-oncall') renderOncallPage();
    else if(on.id==='page-data') renderDataPage();
    else if(on.id==='page-stats') renderStatsPage();
    else if(on.id==='page-save') renderSavePage();
  }

  // ====== Accueil ======
  function renderAccueil(){ /* rien de spécial pour l’instant */ }

  // ====== Calendrier ======
  function renderCalendar(){
    const now = new Date();
    const selM = $('#selMonth');
    const selY = $('#selYear');
    if(!selM.dataset.init){
      selM.dataset.init=1;
      ['Jan','Fév','Mar','Avr','Mai','Jun','Jul','Aoû','Sep','Oct','Nov','Déc'].forEach((m,i)=> selM.appendChild(el('option',{value:i},m)));
      selM.value = now.getMonth();
    }
    if(!selY.dataset.init){ selY.dataset.init=1; selY.value = now.getFullYear(); }
    $('#btnGoCal').onclick = ()=> {
      const y = parseInt(selY.value,10); const m = parseInt(selM.value,10);
      const first = new Date(y,m,1);
      const start = new Date(first); start.setDate(1 - ((first.getDay()+6)%7));
      const kal = $('#kal'); kal.innerHTML='';
      for(let i=0;i<42;i++){
        const d = new Date(start); d.setDate(start.getDate()+i);
        const inMonth = d.getMonth()===m;
        const box = el('div',{class:'day'},
          el('div',{class:'head'}, el('span',{}, d.toLocaleDateString('fr-FR',{weekday:'short'})), el('span',{}, d.getDate().toString())),
          el('div', {class:'small muted'}, inMonth? '':'(hors mois)')
        );
        if(!inMonth) box.style.opacity=.5;
        kal.appendChild(box);
      }
    };
  }

  // ====== Planning praticien ======
  function renderPracPage(){
    const selP = $('#selPrac'); const selW=$('#selWPrac'); const selY=$('#selYPrac'); const view=$('#pracView');
    if(!selP.dataset.init){ selP.dataset.init=1; data.practitioners.forEach(p=> selP.appendChild(el('option',{}, p.name))); selW.value=data.week; selY.value=data.year; }
    function draw(){ view.innerHTML=''; const who=selP.value; view.appendChild(el('div',{}, 'Semaine '+selW.value+' · '+selY.value+' — '+who)); }
    selP.onchange=selW.onchange=selY.onchange=()=>{ draw(); };
    draw();
  }

  // ====== Planning interne ======
  function renderInternPage(){
    const sel = $('#selIntern'); const selW=$('#selWIntern'); const selY=$('#selYIntern'); const view=$('#internView');
    if(!sel.dataset.init){ sel.dataset.init=1; data.interns.forEach(p=> sel.appendChild(el('option',{}, p.name))); selW.value=data.week; selY.value=data.year; }
    function draw(){ view.innerHTML=''; const who=sel.value; view.appendChild(el('div',{}, 'Semaine '+selW.value+' · '+selY.value+' — '+who)); }
    sel.onchange=selW.onchange=selY.onchange=()=>{ draw(); };
    draw();
  }

  // ====== Absences & Remplacements ======
  function renderAbsRep(){
    const box = $('#absrepView'); box.innerHTML='';
    box.appendChild(el('div', {class:'muted'}, 'Interface de gestion des absences et remplacements (à compléter).'));
  }

  // ====== Semaine type (salles) ======
  function renderWeekPage(){
    const rSel=$('#wkRoom'), dSel=$('#wkDay'), sSel=$('#wkSpec'), pSel=$('#wkPrac'), iSel=$('#wkIntern');
    if(!rSel.dataset.init){
      rSel.dataset.init=1;
      data.rooms.forEach((r,ri)=> rSel.appendChild(el('option',{value:ri}, r.label)));
      ['Lun','Mar','Mer','Jeu','Ven','Sam','Dim'].forEach((d,di)=> dSel.appendChild(el('option',{value:di}, d)));
      data.specialties.forEach(spec=> sSel.appendChild(el('option',{}, spec)));
      data.practitioners.forEach(p=> pSel.appendChild(el('option',{}, p.name)));
      data.interns.forEach(p=> iSel.appendChild(el('option',{}, p.name)));
    }
    $('#wkApply').onclick = ()=>{
      alert('Exemple : appliquera la ligne dans la grille de la salle (à compléter/la logique est simplifiée ici).');
    };
    $('#wkClear').onclick = ()=>{
      alert('Exemple : videra la ligne sélectionnée (à compléter).');
    };
    const view=$('#wkView'); view.innerHTML='(Aperçu de la grille semaine type — à compléter)';
  }

  // ====== Absences ======
  function renderAbsPage(){ $('#absView').innerHTML='(Tableau des absences — à compléter)'; }
  // ====== Gardes ======
  function renderGuardPage(){ $('#guardView').innerHTML='(Tableau des gardes — à compléter)'; }
  // ====== Astreintes ======
  function renderOncallPage(){ $('#oncallView').innerHTML='(Tableau des astreintes — à compléter)'; }

  // ====== Données ======
  function renderDataPage(){
    const specBox=$('#specView'); const pracBox=$('#pracList'); const internBox=$('#internList'); const roomsBox=$('#roomsView');
    if(!specBox.dataset.init){
      specBox.dataset.init=1;
      const ul=el('ul', {});
      data.specialties.forEach(sp=> ul.appendChild(el('li',{}, sp)));
      specBox.appendChild(ul);
    }
    if(!pracBox.dataset.init){
      pracBox.dataset.init=1;
      const ul=el('ul', {});
      data.practitioners.forEach(p=> ul.appendChild(el('li',{}, p.name+ (p.cinaps?' (CINAPS)':''))));
      pracBox.appendChild(ul);
    }
    if(!internBox.dataset.init){
      internBox.dataset.init=1;
      const ul=el('ul', {});
      data.interns.forEach(p=> ul.appendChild(el('li',{}, p.name)));
      internBox.appendChild(ul);
    }
    if(!roomsBox.dataset.init){
      roomsBox.dataset.init=1;
      const ul=el('ul', {});
      data.rooms.forEach(r=> ul.appendChild(el('li',{}, r.label+ (r.allowTele? ' · Télérad OK':'') + (r.allowCinaps? ' · CINAPS OK':''))));
      roomsBox.appendChild(ul);
    }
  }

  // ====== Statistiques ======
  function renderStatsPage(){ $('#statsView').innerHTML='(Statistiques — à compléter)'; }

  // ====== Sauvegarde ======
  function renderSavePage(){
    $('#btnExport').onclick = ()=>{
      const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'neptune-data.json';
      a.click();
      setTimeout(()=> URL.revokeObjectURL(a.href), 1000);
    };
    $('#fileImport').onchange = async (ev)=>{
      const f = ev.target.files[0]; if(!f) return;
      const txt = await f.text();
      try{ data = JSON.parse(txt); writeEmbed(data); saveLocal(); updateBadges(); alert('Données importées.'); }catch(e){ alert('JSON invalide'); }
    };
    $('#btnPick').onclick = pickHtmlFile;
    $('#btnSaveHtml').onclick = saveHtmlToDisk;
    $('#pullCentral').onclick = pullCentral;
    $('#pushCentral').onclick = pushCentral;
  }

  // ====== Persistance locale ======
  function saveLocal(){ localStorage.setItem('NEPTUNE_DATA', JSON.stringify(data)); }
  function loadLocal(){ const s=localStorage.getItem('NEPTUNE_DATA'); if(s){ try{ data=JSON.parse(s);}catch(e){} } }

  // ====== Écriture du JSON intégré ======
  function writeEmbed(d){
    const tag = document.getElementById('NEPTUNE_EMBED');
    tag.textContent = JSON.stringify(d, null, 2);
  }

  // ====== File System Access API (autosauvegarde dans le fichier) ======
  let chosenHandle = null;
  async function pickHtmlFile(){
    try{
      chosenHandle = await window.showOpenFilePicker({types:[{description:'HTML', accept:{'text/html':['.html','.htm']}}], multiple:false}).then(x=>x[0]);
      const f = await chosenHandle.getFile();
      if(!/\.html?$/i.test(f.name)) { alert('Sélectionne le fichier HTML de l’outil.'); return; }
      $('#pickHint').textContent = 'Fichier relié : '+f.name;
    }catch(e){ alert('Sélection annulée'); }
  }
  async function saveHtmlToDisk(){
    if(!chosenHandle){ alert('Choisis d’abord le fichier HTML (bouton ci‑dessus).'); return; }
    const f = await chosenHandle.getFile();
    const txt = await f.text();
    const out = txt.replace(/(<script id=\"NEPTUNE_EMBED\"[^>]*>)([\s\S]*?)(<\/script>)/, (m,a,mid,c)=> a+JSON.stringify(data,null,2)+c);
    const ws = await chosenHandle.createWritable();
    await ws.write(out); await ws.close();
    alert('Page enregistrée avec les données intégrées.');
  }

  // ====== JsonStorage (sauvegarde centralisée) ======
  const FIXED_URI = "https://api.jsonstorage.net/v1/json/88ff1334-435e-4e42-bcf4-65ee4777fa1f/f34e9f5e-ac59-4c7c-a5c5-712c3ff1452c";
  const API_KEY   = "1c5f1698-c8f7-4992-988a-d1ae29cb35ee";
  async function pullCentral(){
    try{
      const res = await fetch(FIXED_URI, {headers:{'x-api-key': API_KEY}});
      if(!res.ok) throw new Error('HTTP '+res.status);
      const remote = await res.json();
      if(!remote || typeof remote!== 'object') throw new Error('Réponse JSON invalide');
      data = remote; writeEmbed(data); saveLocal(); updateBadges();
      alert('Recharge effectuée depuis le stockage central.');
    }catch(e){ alert('Échec recharge: '+e.message); }
  }
  async function pushCentral(){
    try{
      const res = await fetch(FIXED_URI, {method:'PUT', headers:{'Content-Type':'application/json','x-api-key': API_KEY}, body: JSON.stringify(data)});
      if(!res.ok) throw new Error('HTTP '+res.status);
      alert('Données poussées vers le stockage central.');
    }catch(e){ alert('Échec push: '+e.message); }
  }

  // ====== Fils d’UI ======
  $('#prevW').onclick = ()=>{ data.week = Math.max(1, (data.week|0)-1); updateBadges(); refreshActivePage(); };
  $1
  $('#btnPullNow').onclick = pullCentral;
  $('#btnPushNow').onclick = pushCentral;
  $('#logout').onclick = ()=>{ sessionStorage.removeItem('role'); askAuth(); };

  // ====== Boot ======
  (function boot(){
    loadLocal();
    updateBadges();
    // onglets init
    renderSavePage(); // branche les boutons (certains listeners ont besoin d’être actifs dès l’ouverture)
    askAuth();
  })();
  </script>
</body></html>
