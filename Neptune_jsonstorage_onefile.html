<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Neptune — JSON central via JsonStorage (1 fichier)</title>
<style>
  :root{--bg:#0b0f14;--fg:#e6eef8;--muted:#9fb3c8;--card:#121925;--line:#1f2b40;}
  *{box-sizing:border-box}
  body{margin:0;font:14px/1.4 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:var(--fg);background:linear-gradient(180deg,#0b0f14,#0f1724)}
  header{padding:18px 16px;background:linear-gradient(90deg,#0f1724,#142135);border-bottom:1px solid #22324d;position:sticky;top:0}
  h1{margin:0;font-size:18px} .muted{color:var(--muted)}
  main{padding:18px;max-width:1100px;margin:0 auto}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px}
  .card-h{padding:12px 14px;border-bottom:1px solid var(--line);color:#b8c7da;font-weight:600}
  .card-b{padding:14px}
  .controls{display:flex;flex-wrap:wrap;gap:8px}
  button{padding:8px 12px;border-radius:10px;border:1px solid #2a3b58;background:#142135;color:var(--fg);cursor:pointer}
  button.primary{background:#184a7a;border-color:#2f6fb1}
  input,textarea{width:100%;padding:8px 10px;border:1px solid #233450;border-radius:10px;background:#0f1724;color:var(--fg)}
  textarea{min-height:280px;resize:vertical;font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;font-size:13px}
  .status{margin-top:10px;font-size:12px;color:#b4c3d7}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;background:#112036;border:1px solid #274267;color:#b9d5f7;font-size:12px}
  @media (max-width:900px){.grid{grid-template-columns:1fr}}
</style>
</head>
<body>
<header>
  <h1>Neptune — JSON central via JsonStorage (1 fichier)</h1>
  <div class="muted">Fonctionne sur n'importe quel hébergement HTTPS / CodePen. CORS OK côté JsonStorage.</div>
</header>
<main>
  <div class="grid">
    <section class="card">
      <div class="card-h">Configurer JsonStorage</div>
      <div class="card-b">
        <label>Clé API (Create/Update) <input id="apiKey" type="password" placeholder="votre clé JsonStorage"/></label>
        <label style="margin-top:8px">URI existant (facultatif) <input id="uri" type="text" placeholder="https://api.jsonstorage.net/v1/json/USER/ITEM"/></label>
        <div class="controls" style="margin-top:10px">
          <button id="btnCreate" class="primary">Créer un JSON</button>
          <button id="btnAttach">Lier l’URI</button>
          <button id="btnForget" class="ghost">Désactiver</button>
        </div>
        <div class="status" id="cfgStatus">—</div>
      </div>
    </section>

    <section class="card">
      <div class="card-h">Éditer les données</div>
      <div class="card-b">
        <textarea id="editor" spellcheck="false"></textarea>
        <div class="controls" style="margin-top:10px">
          <button id="btnSave" class="primary">Enregistrer (local)</button>
          <button id="btnPush">Pousser → JsonStorage</button>
          <button id="btnPull">← Recharger depuis JsonStorage</button>
        </div>
        <div class="status" id="status">—</div>
        <div class="muted" style="margin-top:10px">
          Règle: <b>le plus récent gagne</b> via <code>__meta.updatedAt</code>. Auto-sync toutes <b>30 s</b> quand une config est active.
        </div>
      </div>
    </section>
  </div>
</main>

<script>
// --- stockage local simple (localStorage) pour conserver clé/uri entre ouvertures
function saveCfg(c){ localStorage.setItem('js-cfg', JSON.stringify(c||{})); }
function loadCfg(){ try{ return JSON.parse(localStorage.getItem('js-cfg')||'{}'); }catch(e){ return {}; } }
function setCfgStatus(m){ const el=document.getElementById('cfgStatus'); if(el) el.textContent=m+' ('+new Date().toLocaleTimeString()+')'; }
function setStatus(m){ const el=document.getElementById('status'); if(el) el.textContent=m+' ('+new Date().toLocaleTimeString()+')'; }
function deviceId(){ try{ let id=localStorage.getItem('neptune-device'); if(!id){ id=Math.random().toString(36).slice(2)+'-'+Date.now().toString(36); localStorage.setItem('neptune-device',id);} return id; }catch(e){ return 'unknown-device'; } }
function deepEq(a,b){ try{ return JSON.stringify(a)===JSON.stringify(b); } catch(e){ return false; } }
let data = {};
function showEditor(){ document.getElementById('editor').value = JSON.stringify(data, null, 2); }
function readEditor(){ try{ data = JSON.parse(document.getElementById('editor').value||'{}'); return true; } catch(e){ alert('JSON invalide: '+e.message); return false; } }
function stampMeta(){ try{ if(!data.__meta) data.__meta={}; data.__meta.updatedAt=new Date().toISOString(); data.__meta.by=deviceId(); }catch(e){} }

// --- JsonStorage helpers
async function jsCreate(apiKey){ const url='https://api.jsonstorage.net/v1/json?apiKey='+encodeURIComponent(apiKey); const r=await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({})}); if(!r.ok) throw new Error('POST '+r.status); const j=await r.json(); if(!j.uri) throw new Error('Réponse inattendue'); return j.uri; }
async function jsGet(uri, apiKey){
  let r = await fetch(uri, { method:'GET', cache:'no-cache' });
  if(r.status===401 || r.status===403){
    r = await fetch(uri + (uri.includes('?')?'&':'?') + 'apiKey=' + encodeURIComponent(apiKey), { method:'GET', cache:'no-cache' });
  }
  if(!r.ok) throw new Error('GET '+r.status);
  return r.json();
}
async function jsPut(uri, apiKey, obj){
  const putUrl = uri + (uri.includes('?')?'&':'?') + 'apiKey=' + encodeURIComponent(apiKey);
  const r = await fetch(putUrl, { method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify(obj, null, 2) });
  if(!r.ok) throw new Error('PUT '+r.status);
  return r.json();
}

// --- actions
let timer=null;
async function pull(cfg){
  if(!cfg.uri) return;
  try{
    const remote = await jsGet(cfg.uri, cfg.apiKey||'');
    const ru = (remote && remote.__meta && remote.__meta.updatedAt) ? Date.parse(remote.__meta.updatedAt) : 0;
    const lu = (data && data.__meta && data.__meta.updatedAt) ? Date.parse(data.__meta.updatedAt) : 0;
    if(ru && ru > lu){ data = remote; showEditor(); setStatus('Mise à jour tirée'); } else { setStatus('Déjà à jour'); }
  }catch(e){ console.warn(e); setStatus('Échec lecture'); }
}
async function push(cfg){
  if(!cfg.uri) return;
  try{
    if(!deepEq(JSON.parse(JSON.stringify(data)), JSON.parse(document.getElementById('editor').value||'{}'))){
      if(!readEditor()) return;
    }
    stampMeta();
    await jsPut(cfg.uri, cfg.apiKey||'', data);
    setStatus('Données poussées');
  }catch(e){ console.warn(e); setStatus('Échec écriture'); }
}
function startSync(cfg){
  if(timer) clearInterval(timer);
  if(!cfg || !cfg.uri) return;
  (async ()=>{
    try{
      const remote = await jsGet(cfg.uri, cfg.apiKey||'');
      const ru = (remote && remote.__meta && remote.__meta.updatedAt) ? Date.parse(remote.__meta.updatedAt) : 0;
      const lu = (data && data.__meta && data.__meta.updatedAt) ? Date.parse(data.__meta.updatedAt) : 0;
      if(!ru){ stampMeta(); await jsPut(cfg.uri, cfg.apiKey||'', data); setStatus('Central initialisé'); }
      else if(ru > lu){ data = remote; showEditor(); setStatus('Synchronisé (pull)'); }
      else if(lu > ru || !deepEq(remote, data)){ stampMeta(); await jsPut(cfg.uri, cfg.apiKey||'', data); setStatus('Synchronisé (push)'); }
      else setStatus('Synchronisation OK');
    }catch(e){ console.warn(e); setStatus('Sync interrompue'); }
  })();
  timer = setInterval(()=>pull(cfg), 30000);
}

// --- UI wiring
document.addEventListener('DOMContentLoaded', async ()=>{
  // init editor
  data = {}; showEditor();
  const cfg = loadCfg();
  if(cfg.apiKey) document.getElementById('apiKey').value = cfg.apiKey;
  if(cfg.uri) document.getElementById('uri').value = cfg.uri;
  if(cfg.uri) { setCfgStatus('JsonStorage prêt: ' + cfg.uri); startSync(cfg); }

  document.getElementById('btnCreate').onclick = async ()=>{
    const apiKey = (document.getElementById('apiKey').value||'').trim();
    if(!apiKey) return alert('Entrez la clé API JsonStorage');
    try{
      const uri = await jsCreate(apiKey);
      saveCfg({ apiKey, uri });
      document.getElementById('uri').value = uri;
      setCfgStatus('Item créé: ' + uri);
      startSync({ apiKey, uri });
    }catch(e){ alert('Échec création: '+(e.message||e)); }
  };
  document.getElementById('btnAttach').onclick = async ()=>{
    const apiKey = (document.getElementById('apiKey').value||'').trim();
    const uri = (document.getElementById('uri').value||'').trim();
    if(!apiKey || !uri) return alert('Entrez clé API et URI.');
    saveCfg({ apiKey, uri });
    setCfgStatus('URI lié: ' + uri);
    startSync({ apiKey, uri });
  };
  document.getElementById('btnForget').onclick = ()=>{ saveCfg({}); setCfgStatus('JsonStorage désactivé'); if(timer) clearInterval(timer); };

  document.getElementById('btnSave').onclick = ()=>{ if(readEditor()){ stampMeta(); showEditor(); setStatus('Données prêtes à pousser'); } };
  document.getElementById('btnPush').onclick = ()=>{ const c=loadCfg(); push(c); };
  document.getElementById('btnPull').onclick = ()=>{ const c=loadCfg(); pull(c); };
});
</script>
</body>
</html>
